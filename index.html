<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <title>Seguimiento de Ubicación y Nómina</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <style>
        /* Estilos CSS mejorados */
        .tabs {
            margin: 20px 0;
            gap: 10px;
            display: none;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #map {
            height: 70vh;
            width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #loginModal div {
            background: white;
            width: 300px;
            padding: 20px;
            border-radius: 8px;
        }
        #loginModal input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        #loginModal button {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #loginModal button:hover {
            background: #1d4ed8;
        }
        .info-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .nomina-panel {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            #map {
                height: 60vh;
                margin: 10px 0;
            }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2563eb;
            color: white;
        }
        #logoutBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }
        #logoutBtn:hover {
            background: #b91c1c;
        }
        .upload-section {
            margin: 15px;
            padding: 15px;
            background: #e2e8f0;
            border-radius: 8px;
        }
        .programacion-table {
            margin-top: 20px;
        }
        .confirmar-btn {
            padding: 5px 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirmado {
            background: #34d399;
        }
        .programacion-panel {
            display: none;
        }
        .rechazar-btn {
            padding: 5px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .notificaciones-panel {
            margin: 15px;
            padding: 15px;
            background: #fecaca;
            border-radius: 8px;
        }
        .notificacion-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-wrapper {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('App funciona offline'))
                .catch(err => console.log('Error:', err));
        }

        // Variables globales
        let map;
        let sedes = [];
        let usuarioActual = null;
        let userMarker = null;
        let accuracyCircle = null;
        let polyline = null;
        let trabajadoresMarkers = {};
        let sedeAssignments = {};
        let markerCluster;

        const USUARIOS = {
            administradores: {
                'WENDY': {password: 'WENDY123!', role: 'admin'},
                'LAURA': {password: 'LAURA456@', role: 'admin'},
                'JOSE': {password: 'JOSE789#', role: 'admin'},
                'ANDRES': {password: 'ANDRES012$', role: 'admin'},
                'FABIO': {password: 'FABIO345%', role: 'admin'},
                'CRISTIAN': {password: 'CRISTIAN678^', role: 'admin'}
            },
            trabajadores: {
                'PRUEBA': {
                    password: 'PRUEBA123',
                    role: 'worker',
                    nomina: [
                        { fecha: '2023-10-01', horas: 8, valorHora: 15000 },
                        { fecha: '2023-10-02', horas: 6, valorHora: 15000 },
                        { fecha: '2023-10-03', horas: 7, valorHora: 15000 }
                    ]
                }
            }
        };

        const CONFIG = {
            destino: {
                lat: 4.688636,
                lng: -74.132025,
                radio: 170
            },
            opcionesMapa: {
                zoomInicial: 15,
                maxZoom: 19
            },
            estilos: {
                lineaConexion: {
                    color: '#2563eb',
                    peso: 3,
                    opacidad: 0.7
                },
                precision: {
                    color: '#3b82f6',
                    relleno: 0.2,
                    escala: 0.5
                }
            }
        };

        function cerrarSesion() {
            sessionStorage.removeItem('session');
            usuarioActual = null;
            document.querySelector('.content-wrapper').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            if(map) {
                map.remove();
                map = null;
                userMarker = null;
                accuracyCircle = null;
                polyline = null;
                if (markerCluster) {
                    markerCluster.clearLayers();
                    markerCluster = null;
                }
            }
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function inicializarMapa() {
            if (!map) {
                map = L.map('map', {
                    preferCanvas: true, // Usar canvas para mejorar el rendimiento
                    maxZoom: CONFIG.opcionesMapa.maxZoom
                }).setView([CONFIG.destino.lat, CONFIG.destino.lng], CONFIG.opcionesMapa.zoomInicial);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                const destinoIcon = L.icon({
                    iconUrl: './marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });
                L.marker([CONFIG.destino.lat, CONFIG.destino.lng], { icon: destinoIcon })
                    .addTo(map)
                    .bindPopup('<b>Punto de Destino</b><br>Bogotá D.C.')
                    .openPopup();

                // Inicializar el cluster de marcadores
                markerCluster = L.markerClusterGroup();
                map.addLayer(markerCluster);

                if (usuarioActual.role === 'admin') {
                    cargarUbicacionesTrabajadores();
                }
            }
        }

        function cargarUbicacionesTrabajadores() {
            const ubicaciones = JSON.parse(localStorage.getItem('ubicaciones')) || {};
            const asignaciones = JSON.parse(localStorage.getItem('asignaciones')) || {};
            const sedes = JSON.parse(localStorage.getItem('sedes')) || [];

            Object.keys(ubicaciones).forEach(trabajador => {
                const ubicacion = ubicaciones[trabajador];
                const sedeAsignada = sedes.find(s => s.Nombre === asignaciones[trabajador]);

                if(trabajadoresMarkers[trabajador]) {
                    trabajadoresMarkers[trabajador].setLatLng([ubicacion.lat, ubicacion.lng]);
                } else {
                    const marker = L.marker([ubicacion.lat, ubicacion.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            iconSize: [25, 41]
                        })
                    });

                    let popupContent = `<b>${trabajador}</b><br>Última actualización: ${new Date(ubicacion.timestamp).toLocaleTimeString()}`;

                    if(sedeAsignada) {
                        popupContent += `<br>Sede asignada: ${sedeAsignada.Nombre}`;
                        L.polyline([[ubicacion.lat, ubicacion.lng], [sedeAsignada.Latitud, sedeAsignada.Longitud]], {
                            color: 'gray',
                            dashArray: '5'
                        }).addTo(map);
                    }

                    marker.bindPopup(popupContent);
                    trabajadoresMarkers[trabajador] = marker;
                    markerCluster.addLayer(marker); // Añadir al cluster de marcadores
                }
            });
        }

        // Función login única y completa
        function login() {
            const username = document.getElementById('username').value.toUpperCase();
            const password = document.getElementById('password').value;
            
            // Cargar trabajadores desde localStorage
            const trabajadoresImportados = JSON.parse(localStorage.getItem('trabajadores')) || {};
            const USUARIOS_COMBINADOS = {
                ...USUARIOS,
                trabajadores: {...USUARIOS.trabajadores, ...trabajadoresImportados}
            };

            const user = USUARIOS_COMBINADOS.administradores[username] || USUARIOS_COMBINADOS.trabajadores[username];
            
            if(user && user.password === password) {
                usuarioActual = {
                    username: username,
                    role: user.role,
                    datos: user
                };
                document.getElementById('loginModal').style.display = 'none';
                document.querySelector('.content-wrapper').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
                sessionStorage.setItem('session', JSON.stringify(usuarioActual));
                actualizarUI();

                if(usuarioActual.role === 'admin') {
                    inicializarMapa();
                    iniciarGeolocalizacion();
                    cargarNotificaciones();
                } else {
                    mostrarNomina();
                    cargarProgramacionTrabajador();
                    document.querySelector('.tabs').style.display = 'none';
                    document.querySelector('.nomina-panel').style.display = 'block';
                    document.getElementById('mapa').style.display = 'none';
                    document.getElementById('sedes').style.display = 'none';
                    document.querySelector('.notificaciones-panel').style.display = 'none';
                    document.querySelector('.upload-section').style.display = 'none';
                }

                if(usuarioActual.role === 'worker') {
                    iniciarTrackingTrabajador();
                }
            } else {
                alert('Credenciales incorrectas');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
            }
        }

        // Función para procesar archivo de trabajadores
        function procesarTrabajadores() {
            const file = document.getElementById('excelTrabajadores').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    // Validar columnas requeridas
                    if(!jsonData[0]?.['Número de Documento'] || !jsonData[0]?.Nombre || !jsonData[0]?.['Número de Celular']) {
                        throw new Error("Formato incorrecto. Columnas requeridas: Número de Documento, Nombre, Número de Celular");
                    }

                    const trabajadores = jsonData.reduce((acc, t) => {
                        acc[t.Nombre.toUpperCase()] = {
                            password: t['Número de Documento'],
                            role: 'worker',
                            documento: t['Número de Documento'],
                            celular: t['Número de Celular'],
                            nomina: []
                        };
                        return acc;
                    }, {});

                    localStorage.setItem('trabajadores', JSON.stringify(trabajadores));
                    actualizarListaTrabajadores();
                    mostrarTablaTrabajadores(trabajadores);
                    alert("Trabajadores importados exitosamente!");
                } catch (error) {
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Función para actualizar lista de trabajadores
        function actualizarListaTrabajadores() {
            const trabajadores = JSON.parse(localStorage.getItem('trabajadores')) || {};
            const sedes = JSON.parse(localStorage.getItem('sedes')) || [];
            
            // Actualizar selects
            const selectTrabajador = document.getElementById('selectTrabajador');
            const selectSede = document.getElementById('selectSede');
            
            selectTrabajador.innerHTML = '<option value="">Seleccionar Trabajador</option>';
            selectSede.innerHTML = '<option value="">Seleccionar Sede</option>';
            
            Object.keys(trabajadores).forEach(t => {
                selectTrabajador.innerHTML += `<option value="${t}">${t}</option>`;
            });
            
            sedes.forEach(s => {
                selectSede.innerHTML += `<option value="${s.Nombre}">${s.Nombre}</option>`;
            });
        }

        // Función para mostrar la tabla de trabajadores
        function mostrarTablaTrabajadores(trabajadores) {
            const tbody = document.getElementById('tablaTrabajadores');
            tbody.innerHTML = '';

            Object.entries(trabajadores).forEach(([nombre, datos]) => {
                const row = `
                    <tr>
                        <td>${nombre}</td>
                        <td>${datos.documento}</td>
                        <td>${datos.celular}</td>
                        <td>${datos.role}</td>
                        <td>${datos.password}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Función para validar si el usuario está en el área permitida
        function validarAreaPermitida(lat, lng) {
            const distancia = calcularDistancia(lat, lng, CONFIG.destino.lat, CONFIG.destino.lng);
            return distancia <= CONFIG.destino.radio;
        }

        // Función para confirmar un turno
        function confirmarTurno(fecha) {
            if(confirm("¿Estás seguro de confirmar este turno?")) {
                let programacion = JSON.parse(localStorage.getItem('programacion'));
                programacion = programacion.map(t => {
                    if(t.Nombre === usuarioActual.username && t.Fecha === fecha) {
                        return {
                            ...t,
                            estado: 'confirmado',
                            fechaConfirmacion: new Date().toISOString()
                        };
                    }
                    return t;
                });
                localStorage.setItem('programacion', JSON.stringify(programacion));
                cargarProgramacionTrabajador();
            }
        }

        // Función para inicializar la interfaz de usuario
        function inicializarUI() {
            const session = sessionStorage.getItem('session');
            if (session) {
                usuarioActual = JSON.parse(session);
                actualizarUI();
                if (usuarioActual.role === 'admin') {
                    inicializarMapa();
                    iniciarGeolocalizacion();
                    cargarNotificaciones();
                } else {
                    mostrarNomina();
                    cargarProgramacionTrabajador();
                }
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        // Función para manejar el evento de carga de la ventana
        window.onload = function() {
            try {
                inicializarUI();
                document.getElementById('logoutBtn').style.display = sessionStorage.getItem('session') ? 'block' : 'none';
            } catch (error) {
                console.error('Error durante la inicialización:', error);
                alert('Ocurrió un error durante la inicialización. Revisa la consola para más detalles.');
            }
        };
    </script>
</body>
</html>
