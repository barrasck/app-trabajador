<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>AMA PLUS LOGISTICS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
        <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <!-- Configuraci√≥n de Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "amalogistic-d2a79.firebaseapp.com",
            databaseURL: "https://amalogistic-d2a79-default-rtdb.firebaseio.com",
            projectId: "amalogistic-d2a79",
            storageBucket: "amalogistic-d2a79.appspot.com",
            messagingSenderId: "TU_MESSAGING_ID",
            appId: "TU_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    <style>
        /* Estilos CSS mejorados */
        .tabs {
            margin: 20px 0;
            gap: 10px;
            display: none;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #map {
            height: 70vh;
            width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #loginModal div {
            background: white;
            width: 300px;
            padding: 20px;
            border-radius: 8px;
        }
        #loginModal input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        #loginModal button {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #loginModal button:hover {
            background: #1d4ed8;
        }
        .info-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .nomina-panel {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            #map {
                height: 60vh;
                margin: 10px 0;
            }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2563eb;
            color: white;
        }
        #logoutBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }
        #logoutBtn:hover {
            background: #b91c1c;
        }
        .upload-section {
            margin: 15px;
            padding: 15px;
            background: #e2e8f0;
            border-radius: 8px;
        }
        .programacion-table {
            margin-top: 20px;
        }
        .confirmar-btn {
            padding: 5px 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirmado {
            background: #34d399;
        }
        .programacion-panel {
            display: none;
        }
        .rechazar-btn {
            padding: 5px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .notificaciones-panel {
            margin: 15px;
            padding: 15px;
            background: #fecaca;
            border-radius: 8px;
        }
        .notificacion-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-wrapper {
            display: none;
        }
        #compartiendo-ubicacion {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        #compartiendo-ubicacion th, #compartiendo-ubicacion td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        #compartiendo-ubicacion th {
            background-color: #2563eb;
            color: white;
        }

        .form-section {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    background: #f8fafc;
}

.form-section h4 {
    color: #2563eb;
    margin: 0 0 10px 0;
    font-size: 16px;
}

input[type="text"],
input[type="email"],
input[type="tel"],
input[type="date"],
select {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
}
        
    </style>
</head>
<body>
    <button id="logoutBtn" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
<div id="loginModal">
  <div>
    <h2>üîê Inicio de Sesi√≥n</h2>
    <input type="email" id="email" placeholder="Correo electr√≥nico" required>
    <input type="password" id="password" placeholder="Contrase√±a" required>
    <button onclick="login(event)">Ingresar</button>
  </div>
</div>
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('programacion', event)">üìÖ Programaci√≥n</button>
        <button class="tab-btn" onclick="openTab('mapa', event)">üó∫Ô∏è Mapa</button>
        <button class="tab-btn" onclick="openTab('sedes', event)">üè¢ Sedes</button>
        <button class="tab-btn" onclick="openTab('trabajadores', event)">üë∑ Trabajadores</button>
    </div>
    <div class="content-wrapper">
        <!-- Panel para administradores -->
        <div class="info-panel">
            <div id="programacion" class="tab-content active">
                <div class="upload-section">
                    <h3>üì§ Subir Programaci√≥n</h3>
                    <input type="file" id="excelProgramacion" accept=".xlsx, .xls">
                    <button onclick="procesarProgramacion()">Cargar Programaci√≥n</button>
                    <div id="programacionData"></div>
                </div>
                <div class="notificaciones-panel">
                    <h3>üö® Notificaciones</h3>
                    <div id="listaNotificaciones"></div>
                </div>
            </div>
            <div id="mapa" class="tab-content">
                <div id="map"></div>
                <table id="compartiendo-ubicacion">
                    <thead>
                        <tr>
                            <th>Trabajador</th>
                            <th>Latitud</th>
                            <th>Longitud</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="sedes" class="tab-content">
                <div class="upload-section">
                    <h3>üì§ Subir Sedes</h3>
                    <input type="file" id="excelSedes" accept=".xlsx, .xls">
                    <button onclick="procesarSedes()">Cargar Sedes</button>
                </div>
                <form id="add-sede-form">
                    <label for="sede-name">Nombre de la Sede:</label>
                    <input type="text" id="sede-name" required />
                    <label for="sede-lat">Latitud:</label>
                    <input type="number" id="sede-lat" step="any" required />
                    <label for="sede-lng">Longitud:</label>
                    <input type="number" id="sede-lng" step="any" required />
                    <button type="submit">Agregar Sede</button>
                </form>
                <div id="sedes-list">
                    <h3>Sedes:</h3>
                    <ul id="sedes"></ul>
                </div>
            </div>
            <div id="trabajadores" class="tab-content">
                <div class="upload-section">
<div id="crearTrabajador" class="upload-section">
    <h3>üÜï Crear Trabajador</h3>
    
    <!-- Secci√≥n 1: Foto e Identificaci√≥n -->
    <div class="form-section">
        <h4>üì∑ Foto y Documento</h4>
        <input type="file" id="fotoTrabajador" accept="image/*" required>
        <select id="tipoDocumento" required>
            <option value="">Tipo de Documento</option>
            <option value="C√©dula">C√©dula</option>
            <option value="Pasaporte">Pasaporte</option>
        </select>
        <input type="text" id="numeroDocumento" placeholder="N√∫mero de Documento" required>
    </div>

    <!-- Secci√≥n 2: Datos Personales -->
    <div class="form-section">
        <h4>üë§ Datos Personales</h4>
        <input type="text" id="nombreApellidos" placeholder="Nombre completo" required>
        <input type="date" id="fechaNacimiento" required>
        <select id="rh" required>
            <option value="">Grupo Sangu√≠neo</option>
            <option value="A+">A+</option>
            <option value="O-">O-</option>
            <!-- Agregar otros tipos -->
        </select>
        <select id="genero" required>
            <option value="">G√©nero</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
        </select>
    </div>

    <!-- Secci√≥n 3: Datos de Contacto -->
    <div class="form-section">
        <h4>üìû Contacto</h4>
        <input type="email" id="correoElectronico" placeholder="Correo electr√≥nico" required>
        <input type="text" id="ciudad" placeholder="Ciudad" required>
        <input type="text" id="barrioResidencia" placeholder="Barrio de Residencia">
        <input type="text" id="direccionResidencia" placeholder="Direcci√≥n Completa" required>
        <input type="tel" id="telefonoContacto" placeholder="Tel√©fono de Contacto" required>
        <input type="tel" id="telefonoEmergencia" placeholder="Tel√©fono de Emergencia" required>
    </div>

    <!-- Secci√≥n 4: Datos Bancarios -->
    <div class="form-section">
        <h4>üí≥ Datos Bancarios</h4>
        <input type="text" id="banco" placeholder="Banco" required>
        <select id="tipoCuenta" required>
            <option value="">Tipo de Cuenta</option>
            <option value="Ahorros">Ahorros</option>
            <option value="Corriente">Corriente</option>
        </select>
        <input type="text" id="numeroCuenta" placeholder="N√∫mero de Cuenta" required>
    </div>

    <button onclick="crearTrabajador()" class="confirmar-btn">Guardar Trabajador</button>
</div>
                    <div id="listaTrabajadores">
                        <h3>üë∑ Lista de Trabajadores</h3>
                        <ul id="trabajadoresList"></ul>
                    </div>
                    <h3>üì§ Importar Trabajadores</h3>
                    <input type="file" id="excelTrabajadores" accept=".xlsx, .xls">
                    <button onclick="procesarTrabajadores()">Cargar Trabajadores</button>
                </div>
                <div class="asignacion-section">
                    <h3>üîó Asignar Sedes</h3>
                    <select id="selectTrabajador">
                        <option value="">Seleccionar Trabajador</option>
                    </select>
                    <select id="selectSede">
                        <option value="">Seleccionar Sede</option>
                    </select>
                    <button onclick="asignarSede()">Asignar Sede</button>
                </div>
            </div>
        </div>

        <!-- Panel para trabajadores -->
        <div class="nomina-panel">
            <div class="programacion-panel">
                <h3>üìÖ Turnos Asignados</h3>
                <table id="turnosTrabajador">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Turno</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h2>üìÖ Liquidaci√≥n de N√≥mina</h2>
            <div id="nomina-info">
                <p>Usuario: <span id="nombre-trabajador"></span></p>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Horas Trabajadas</th>
                            <th>Valor por Hora</th>
                            <th>Total D√≠a</th>
                        </tr>
                    </thead>
                    <tbody id="registro-nomina"></tbody>
                </table>
                <p style="margin-top: 15px; font-weight: bold;">
                    Total a pagar: $<span id="total-pagar">0</span>
                </p>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script>
        // Variables globales
        let map;
        let sedes = [];
        let usuarioActual = null;
        let userMarker = null;
        let accuracyCircle = null;
        let trabajadoresMarkers = {};

        const USUARIOS = {
            administradores: {
                'WENDY': {password: 'WENDY123!', role: 'admin'},
                'LAURA': {password: 'LAURA456@', role: 'admin'},
                'JOSE': {password: 'JOSE789#', role: 'admin'},
                'ANDRES': {password: 'ANDRES012$', role: 'admin'},
                'FABIO': {password: 'FABIO345%', role: 'admin'},
                'CRISTIAN': {password: 'CRISTIAN678^', role: 'admin'}
            },
            trabajadores: {
                'PRUEBA': {
                    password: 'PRUEBA123',
                    role: 'worker',
                    nomina: [
                        { fecha: '2023-10-01', horas: 8, valorHora: 15000 },
                        { fecha: '2023-10-02', horas: 6, valorHora: 15000 },
                        { fecha: '2023-10-03', horas: 7, valorHora: 15000 }
                    ]
                }
            }
        };

        const CONFIG = {
            destino: {
                lat: 4.688636,
                lng: -74.132025,
                radio: 170
            },
            opcionesMapa: {
                zoomInicial: 15,
                maxZoom: 19
            },
            estilos: {
                precision: {
                    color: '#3b82f6',
                    relleno: 0.2,
                    escala: 0.5
                }
            }
        };

        function cerrarSesion() {
            sessionStorage.removeItem('session');
            usuarioActual = null;
            document.querySelector('.content-wrapper').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            if (map) {
                map.remove();
                map = null;
                userMarker = null;
                accuracyCircle = null;
            }
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        async function login(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        // Autenticar con Firebase
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Obtener datos adicionales de Realtime Database
        const db = firebase.database();
        const snapshot = await db.ref(`usuarios/${user.uid}`).once('value');
        const userData = snapshot.val();

        if (!userData) {
            throw new Error('Usuario no registrado en la base de datos');
        }

        // Establecer usuario actual
        usuarioActual = {
            uid: user.uid,
            email: user.email,
            role: userData.role || 'worker',
            nombre: userData.nombre || 'Sin nombre',
            documento: userData.documento || 'Sin documento'
        };

        // Actualizar UI
        document.getElementById('loginModal').style.display = 'none';
        document.querySelector('.content-wrapper').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        
        // Guardar sesi√≥n
        sessionStorage.setItem('session', JSON.stringify(usuarioActual));
        
        // Cargar datos seg√∫n rol
        if (usuarioActual.role === 'admin') {
            await inicializarMapa();
            cargarUbicacionesTrabajadores();
            cargarNotificaciones();
            document.querySelector('.tabs').style.display = 'flex';
            openTab('programacion', event);
        } else if (usuarioActual.role === 'worker') {
            mostrarNomina();
            iniciarTrackingTrabajador();
            cargarProgramacionTrabajador();
            document.querySelector('.nomina-panel').style.display = 'block';
        }

    } catch (error) {
        console.error('Error en login:', error);
        alert(`Error al iniciar sesi√≥n: ${error.message}`);
        document.getElementById('password').value = ''; // Limpiar contrase√±a
    }
}

        async function cargarUbicacionesTrabajadores() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/ubicaciones.json');
                if (!response.ok) throw new Error('Error al cargar ubicaciones');
                const ubicaciones = await response.json();
                actualizarTablaUbicaciones(ubicaciones);
                actualizarMapaTrabajadores(ubicaciones);
            } catch (error) {
                console.error('Error al cargar ubicaciones:', error);
            }
        }

        async function inicializarMapa() {
            if (!map) {
                map = L.map('map', {
                    maxZoom: CONFIG.opcionesMapa.maxZoom
                }).setView([CONFIG.destino.lat, CONFIG.destino.lng], CONFIG.opcionesMapa.zoomInicial);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                await actualizarSedesEnMapa();
                setInterval(cargarUbicacionesTrabajadores, 10000); // Actualizar cada 10 segundos
            }
        }

        function actualizarMapaTrabajadores(ubicaciones) {
            if (!map) return;
            const procesados = new Set();
            Object.keys(ubicaciones).forEach(trabajadorKey => {
                const ubicacion = ubicaciones[trabajadorKey];
                if (ubicacion && typeof ubicacion.lat === 'number' && typeof ubicacion.lng === 'number') {
                    const marker = trabajadoresMarkers[trabajadorKey];
                    procesados.add(trabajadorKey);
                    if (marker) {
                        marker.setLatLng([ubicacion.lat, ubicacion.lng])
                            .setPopupContent(`Trabajador: ${ubicacion.nombre || trabajadorKey}`);
                    } else {
                        trabajadoresMarkers[trabajadorKey] = L.marker([ubicacion.lat, ubicacion.lng], {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                                iconSize: [25, 41]
                            })
                        }).addTo(map).bindPopup(`Trabajador: ${ubicacion.nombre || trabajadorKey}`);
                    }
                }
            });
            Object.keys(trabajadoresMarkers).forEach(key => {
                if (!procesados.has(key)) {
                    map.removeLayer(trabajadoresMarkers[key]);
                    delete trabajadoresMarkers[key];
                }
            });
        }

        function actualizarTablaUbicaciones(ubicaciones) {
            const tbody = document.querySelector('#compartiendo-ubicacion tbody');
            tbody.innerHTML = '';
            if (!ubicaciones || Object.keys(ubicaciones).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">No hay ubicaciones disponibles</td></tr>';
                return;
            }
            Object.keys(ubicaciones).forEach(trabajadorKey => {
                const ubicacion = ubicaciones[trabajadorKey];
                const row = document.createElement('tr');
                row.innerHTML = ubicacion && ubicacion.lat && ubicacion.lng
                    ? `<td>${trabajadorKey}</td><td>${ubicacion.lat.toFixed(5)}</td><td>${ubicacion.lng.toFixed(5)}</td>`
                    : `<td>${trabajadorKey}</td><td colspan="2">Ubicaci√≥n no disponible</td>`;
                tbody.appendChild(row);
            });
        }

        async function loadSedes() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/sedes.json');
                if (!response.ok) throw new Error('Error al cargar sedes');
                sedes = await response.json();
                const sedesList = document.getElementById('sedes');
                sedesList.innerHTML = '';
                sedes.forEach(sede => {
                    const li = document.createElement('li');
                    li.textContent = `${sede.Nombre} - Lat: ${sede.Latitud}, Lng: ${sede.Longitud}`;
                    sedesList.appendChild(li);
                });
            } catch (error) {
                console.error('Error al cargar sedes:', error);
            }
        }

        document.getElementById('add-sede-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const sedeName = document.getElementById('sede-name').value;
            const sedeLat = parseFloat(document.getElementById('sede-lat').value);
            const sedeLng = parseFloat(document.getElementById('sede-lng').value);

            if (!sedeName || isNaN(sedeLat) || isNaN(sedeLng)) {
                alert('Por favor completa todos los campos.');
                return;
            }

            sedes.push({ Nombre: sedeName, Latitud: sedeLat, Longitud: sedeLng });
            await guardarEnFirebase('sedes', sedes);
            loadSedes();
            actualizarSedesEnMapa();
            alert('Sede agregada exitosamente.');
        });

        async function cargarTrabajadores() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/trabajadores.json');
                if (!response.ok) throw new Error('Error al cargar trabajadores');
                const trabajadores = await response.json();
                const lista = document.getElementById('trabajadoresList');
                lista.innerHTML = '';
                Object.values(trabajadores).forEach(trabajador => {
                    if (trabajador.nombre && trabajador.documento) {
                        const li = document.createElement('li');
                        li.textContent = `${trabajador.nombre} - Documento: ${trabajador.documento}`;
                        lista.appendChild(li);
                    }
                });
            } catch (error) {
                console.error('Error al cargar trabajadores:', error);
            }
        }

        async function procesarTrabajadores() {
            const file = document.getElementById('excelTrabajadores').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (!jsonData[0]?.['N√∫mero de Documento'] || !jsonData[0]?.Nombre || !jsonData[0]?.['N√∫mero de Celular']) {
                        throw new Error("Formato incorrecto. Columnas requeridas: N√∫mero de Documento, Nombre, N√∫mero de Celular");
                    }

                    const trabajadores = jsonData.reduce((acc, t) => {
                        const documento = t['N√∫mero de Documento'];
                        acc[documento] = {
                            password: documento,
                            role: 'worker',
                            documento: documento,
                            nombre: t['Nombre'],
                            celular: t['N√∫mero de Celular'],
                            nomina: []
                        };
                        return acc;
                    }, {});

                    await guardarEnFirebase('trabajadores', trabajadores);
                    cargarTrabajadores();
                    alert("Trabajadores importados exitosamente!");
                } catch (error) {
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        let trabajadores = {};

        function crearTrabajador() {
            const nombre = document.getElementById('nombreTrabajador').value;
            const documento = document.getElementById('documentoTrabajador').value;
            const celular = document.getElementById('celularTrabajador').value;

            if (!nombre || !documento || !celular) {
                alert("Por favor, completa todos los campos.");
                return;
            }

            trabajadores[documento] = {
                nombre: nombre,
                documento: documento,
                celular: celular,
                role: 'worker',
                nomina: []
            };
            actualizarListaTrabajadores();
            document.getElementById('nombreTrabajador').value = '';
            document.getElementById('documentoTrabajador').value = '';
            document.getElementById('celularTrabajador').value = '';
            alert("Trabajador agregado exitosamente.");
        }

        async function actualizarListaTrabajadores() {
            try {
        const db = firebase.database();
        const snapshot = await db.ref("sedes").once("value");
        const sedesData = snapshot.val() || []; // <-- √önica declaraci√≥n

                const selectTrabajador = document.getElementById('selectTrabajador');
                const selectSede = document.getElementById('selectSede');
                selectTrabajador.innerHTML = '<option value="">Seleccionar Trabajador</option>';
                selectSede.innerHTML = '<option value="">Seleccionar Sede</option>';

                Object.keys(trabajadoresData).forEach(t => {
                    selectTrabajador.innerHTML += `<option value="${t}">${trabajadoresData[t].nombre}</option>`;
                });
                sedesData.forEach(s => {
                    selectSede.innerHTML += `<option value="${s.Nombre}">${s.Nombre}</option>`;
                });

                const lista = document.getElementById('trabajadoresList');
                lista.innerHTML = '';
                Object.keys(trabajadoresData).forEach(doc => {
                    const t = trabajadoresData[doc];
                    const li = document.createElement('li');
                    li.textContent = `${t.nombre} (Documento: ${t.documento}, Celular: ${t.celular})`;
                    lista.appendChild(li);
                });
            } catch (error) {
                console.error('Error al actualizar lista de trabajadores:', error);
            }
        }

        async function asignarSede() {
            const trabajador = document.getElementById('selectTrabajador').value;
            const sede = document.getElementById('selectSede').value;

            if (!trabajador || !sede) {
                alert("Seleccione un trabajador y una sede");
                return;
            }

            const db = firebase.database();
const snapshot = await db.ref("programacion").once("value");
const programacion = snapshot.val() || [];
            const asignaciones = response.ok ? await response.json() : {};
            asignaciones[trabajador] = sede;
            await guardarEnFirebase('asignaciones', asignaciones);
            alert("Sede asignada exitosamente!");
        }

async function iniciarTrackingTrabajador() {
    if (!navigator.geolocation || usuarioActual.role !== 'worker') return;

    try {
        const db = firebase.database();
        const ubicacionRef = db.ref(`ubicaciones/${usuarioActual.uid}`);
        
        const watchId = navigator.geolocation.watchPosition(
            async (position) => {
                const ubicacion = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date().toISOString(),
                    nombre: usuarioActual.nombre || 'Trabajador'
                };

                try {
                    // Actualizar Firebase
                    await ubicacionRef.set(ubicacion);
                    
                    // Actualizar mapa en tiempo real
                    if (map) {
                        const latLng = [ubicacion.lat, ubicacion.lng];
                        
                        // Actualizar marcador existente o crear nuevo
                        if (userMarker) {
                            userMarker.setLatLng(latLng)
                                      .setPopupContent(`${usuarioActual.nombre}<br>√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`);
                        } else {
                            userMarker = L.marker(latLng, {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                                    iconSize: [25, 41]
                                })
                            }).addTo(map).bindPopup(usuarioActual.nombre);
                        }

                        // Actualizar c√≠rculo de precisi√≥n
                        if (accuracyCircle) {
                            accuracyCircle.setLatLng(latLng)
                                         .setRadius(ubicacion.accuracy);
                        } else {
                            accuracyCircle = L.circle(latLng, {
                                radius: ubicacion.accuracy,
                                color: '#3b82f6',
                                fillOpacity: 0.2
                            }).addTo(map);
                        }
                    }
                    
                    // Actualizar tabla de ubicaciones
                    actualizarTablaUbicaciones({ [usuarioActual.uid]: ubicacion });

                } catch (error) {
                    console.error('Error al actualizar ubicaci√≥n:', error);
                }
            },
            (error) => {
                console.error('Error de geolocalizaci√≥n:', error);
                alert(`Error de GPS: ${error.message}`);
            },
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            }
        );

        // Detener seguimiento al cerrar sesi√≥n
        window.addEventListener('beforeunload', () => {
            navigator.geolocation.clearWatch(watchId);
            ubicacionRef.remove();
        });

        // Actualizar ubicaciones de otros trabajadores cada 10 segundos
        const interval = setInterval(async () => {
            if (usuarioActual.role === 'worker') return;
            await cargarUbicacionesTrabajadores();
        }, 10000);

        return () => {
            clearInterval(interval);
            navigator.geolocation.clearWatch(watchId);
        };

    } catch (error) {
        console.error('Error en tracking:', error);
        alert('No se pudo iniciar el seguimiento. Verifica los permisos de ubicaci√≥n.');
    }
}

        function actualizarUI() {
            if (usuarioActual.role === 'admin') {
                document.querySelector('.tabs').style.display = 'flex';
                document.querySelector('.content-wrapper').style.display = 'block';
                document.querySelector('.nomina-panel').style.display = 'none';
                openTab('programacion', { currentTarget: document.querySelector('.tab-btn.active') });
            } else if (usuarioActual.role === 'worker') {
                document.querySelector('.tabs').style.display = 'none';
                document.querySelector('.nomina-panel').style.display = 'block';
            }
        }

        function mostrarNomina() {
            const trabajador = usuarioActual.datos;
            const tbody = document.getElementById('registro-nomina');
            let total = 0;
            document.getElementById('nombre-trabajador').textContent = trabajador.username || usuarioActual.username;
            tbody.innerHTML = '';
            (trabajador.nomina || []).forEach(dia => {
                const totalDia = dia.horas * dia.valorHora;
                total += totalDia;
                tbody.innerHTML += `
                    <tr>
                        <td>${dia.fecha}</td>
                        <td>${dia.horas}</td>
                        <td>$${dia.valorHora.toLocaleString()}</td>
                        <td>$${totalDia.toLocaleString()}</td>
                    </tr>
                `;
            });
            document.getElementById('total-pagar').textContent = total.toLocaleString();
        }

        window.onload = async function() {
            const session = sessionStorage.getItem('session');
            document.getElementById('logoutBtn').style.display = session ? 'block' : 'none';
            if (!session) {
                document.getElementById('loginModal').style.display = 'flex';
            } else {
                usuarioActual = JSON.parse(session);
                document.querySelector('.content-wrapper').style.display = 'block';
                actualizarUI();
                if (usuarioActual.role === 'admin') {
                    inicializarMapa();
                    cargarUbicacionesTrabajadores();
                    cargarNotificaciones();
                } else if (usuarioActual.role === 'worker') {
                    mostrarNomina();
                    iniciarTrackingTrabajador();
                    cargarProgramacionTrabajador();
                }
            }
            await cargarTrabajadores();
            await loadSedes();
        };

        async function procesarProgramacion() {
            const file = document.getElementById('excelProgramacion').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (!jsonData[0]?.Sede || !jsonData[0]?.Fecha || !jsonData[0]?.Turno || !jsonData[0]?.Nombre) {
                        throw new Error("Formato incorrecto. Columnas requeridas: Sede, Fecha, Turno, Nombre");
                    }

                    const sedesResponse = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/sedes.json');
                    const sedesData = sedesResponse.ok ? await sedesResponse.json() : [];
                    const sedesInvalidas = jsonData.filter(t => !sedesData.some(s => s.Nombre === t.Sede));
                    if (sedesInvalidas.length > 0) {
                        throw new Error(`Sedes no encontradas: ${sedesInvalidas.map(t => t.Sede).join(', ')}`);
                    }

                    await guardarEnFirebase('programacion', jsonData);
                    mostrarProgramacionAdmin(jsonData);
                    alert("Programaci√≥n cargada exitosamente!");
                } catch (error) {
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function mostrarProgramacionAdmin(data) {
            const contenedor = document.getElementById('programacionData');
            contenedor.innerHTML = `
                <h4>üìã Programaci√≥n Cargada</h4>
                <table class="programacion-table">
                    <thead>
                        <tr>
                            <th>Sede</th>
                            <th>Nombre</th>
                            <th>Fecha</th>
                            <th>Turno</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.Sede}</td>
                                <td>${row.Nombre}</td>
                                <td>${row.Fecha}</td>
                                <td>${row.Turno}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            contenedor.style.display = 'block';
        }

        async function cargarProgramacionTrabajador() {
            try {
                const db = firebase.database();
const snapshot = await db.ref("ubicaciones").once("value");
const ubicaciones = snapshot.val() || {};
                if (!response.ok) throw new Error('No se pudo cargar la programaci√≥n');
                const programacion = await response.json();
                const turnosUsuario = programacion.filter(t => t.Nombre === usuarioActual.username);
                const tbody = document.querySelector('#turnosTrabajador tbody');
                tbody.innerHTML = turnosUsuario.map(turno => `
                    <tr>
                        <td>${turno.Fecha}</td>
                        <td>${turno.Turno}</td>
                        <td>${turno.estado || 'Pendiente'}</td>
                        <td>
                            ${!turno.estado || turno.estado === 'Pendiente' ? `
                            <button class="confirmar-btn" onclick="confirmarTurno('${turno.Fecha}')">Confirmar</button>
                            <button class="rechazar-btn" onclick="rechazarTurno('${turno.Fecha}')">Rechazar</button>` : 'Sin acciones'}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error al cargar programaci√≥n:', error);
            }
        }

        async function confirmarTurno(fecha) {
            try {
                const db = firebase.database();
const snapshot = await db.ref("sedes").once("value");
const sedes = snapshot.val() || [];
                if (!response.ok) throw new Error('No se pudo cargar la programaci√≥n');
                let programacion = await response.json();
                programacion = programacion.map(t => {
                    if (t.Nombre === usuarioActual.username && t.Fecha === fecha) {
                        return { ...t, estado: 'confirmado' };
                    }
                    return t;
                });
                await guardarEnRepositorio('programacion.json', JSON.stringify(programacion, null, 2));
                cargarProgramacionTrabajador();
            } catch (error) {
                console.error('Error al confirmar turno:', error);
                alert('Error al confirmar el turno.');
            }
        }

        async function rechazarTurno(fecha) {
            if (confirm("¬øEst√°s seguro de rechazar este turno?")) {
                try {
                    const db = firebase.database();
const snapshot = await db.ref("trabajadores").once("value");
const trabajadores = snapshot.val() || {};
                    if (!response.ok) throw new Error('No se pudo cargar la programaci√≥n');
                    let programacion = await response.json();
                    programacion = programacion.map(t => {
                        if (t.Nombre === usuarioActual.username && t.Fecha === fecha) {
                            return { ...t, estado: 'rechazado', fechaRechazo: new Date().toISOString() };
                        }
                        return t;
                    });

                    const notificacionesResponse = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/notificaciones.json');
                    const notificaciones = notificacionesResponse.ok ? await notificacionesResponse.json() : [];
                    notificaciones.push({
                        trabajador: usuarioActual.username,
                        fecha: fecha,
                        turno: programacion.find(t => t.Nombre === usuarioActual.username && t.Fecha === fecha).Turno,
                        timestamp: new Date().toISOString()
                    });

                    await guardarEnFirebase('notificaciones', notificaciones);
                    await guardarEnRepositorio('programacion.json', JSON.stringify(programacion, null, 2));
                    cargarProgramacionTrabajador();
                    if (usuarioActual.role === 'admin') cargarNotificaciones();
                } catch (error) {
                    console.error('Error al rechazar turno:', error);
                    alert('Error al rechazar el turno.');
                }
            }
        }

async function cargarNotificaciones() {
    try {
        const db = firebase.database();
        const snapshot = await db.ref("notificaciones").once("value");
        const notificaciones = snapshot.val() || []; // <-- √önica declaraci√≥n

        // Actualizar la interfaz
        const listaNotificaciones = document.getElementById('listaNotificaciones');
        listaNotificaciones.innerHTML = notificaciones.map(notif => `
            <div class="notificacion-item">
                <span>${notif.mensaje}</span>
                <small>${new Date(notif.timestamp).toLocaleDateString()}</small>
            </div>
        `).join('');
        
    } catch (error) {
        console.error("Error al cargar notificaciones:", error);
        alert("No se pudieron cargar las notificaciones.");
    }
}
}

        function openTab(tabName, event) {
            if (usuarioActual.role !== 'admin') return;
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabName === 'mapa' && map) map.invalidateSize();
        }

        async function procesarSedes() {
            const file = document.getElementById('excelSedes').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (!jsonData[0]?.['Nombre'] || !jsonData[0]?.['Latitud'] || !jsonData[0]?.['Longitud']) {
                        throw new Error("Formato incorrecto. Columnas requeridas: Nombre, Latitud, Longitud");
                    }

                    await guardarEnFirebase('sedes', sedes);
                    loadSedes();
                    actualizarSedesEnMapa();
                    alert("Sedes importadas exitosamente!");
                } catch (error) {
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function actualizarSedesEnMapa() {
            if (!map) return;
            try {
                const response = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/sedes.json');
                if (!response.ok) throw new Error('Error al cargar sedes');
                const sedesData = await response.json();
                const sedeIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });
                sedesData.forEach(sede => {
                    L.marker([sede.Latitud, sede.Longitud], { icon: sedeIcon })
                        .addTo(map)
                        .bindPopup(`<b>${sede.Nombre}</b>`);
                });
            } catch (error) {
                console.error('Error al actualizar sedes en mapa:', error);
            }
        }

async function guardarEnFirebase(ruta, datos) {
    try {
        const db = firebase.database();
        const referencia = db.ref(ruta);
        
        await referencia.set(datos);
        console.log("Datos guardados exitosamente en:", ruta);
        return { exito: true, mensaje: "Datos guardados correctamente" };
        
    } catch (error) {
        console.error("Error al guardar en Firebase:", error);
        return { 
            exito: false, 
            mensaje: `Error al guardar: ${error.message || error}` 
        };
    }
}

        async function convertirImagenABase64(file) {
    if (!file) return null;
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]); // Quitar prefijo
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function crearTrabajador() {
    try {
        // Validar campos obligatorios
        const camposRequeridos = ['nombreApellidos', 'correoElectronico', 'numeroDocumento'];
        const faltantes = camposRequeridos.filter(id => !document.getElementById(id).value);
        
        if (faltantes.length > 0) {
            throw new Error(`Campos requeridos: ${faltantes.join(', ')}`);
        }

        // Convertir imagen
        const fotoFile = document.getElementById('fotoTrabajador').files[0];
        const fotoBase64 = await convertirImagenABase64(fotoFile);

        // Recopilar datos
        const trabajadorData = {
            // Secci√≥n 1
            foto: fotoBase64,
            tipoDocumento: document.getElementById('tipoDocumento').value,
            numeroDocumento: document.getElementById('numeroDocumento').value,
            
            // Secci√≥n 2
            nombreApellidos: document.getElementById('nombreApellidos').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            rh: document.getElementById('rh').value,
            genero: document.getElementById('genero').value,
            
            // Secci√≥n 3
            correoElectronico: document.getElementById('correoElectronico').value,
            ciudad: document.getElementById('ciudad').value,
            barrioResidencia: document.getElementById('barrioResidencia').value,
            direccionResidencia: document.getElementById('direccionResidencia').value,
            telefonoContacto: document.getElementById('telefonoContacto').value,
            telefonoEmergencia: document.getElementById('telefonoEmergencia').value,
            
            // Secci√≥n 4
            banco: document.getElementById('banco').value,
            tipoCuenta: document.getElementById('tipoCuenta').value,
            numeroCuenta: document.getElementById('numeroCuenta').value,
            
            // Sistema
            role: "worker",
            fechaRegistro: new Date().toISOString()
        };

        // Guardar en Firebase
        const db = firebase.database();
        await db.ref(`trabajadores/${trabajadorData.numeroDocumento}`).set(trabajadorData);
        
        alert("¬°Trabajador registrado exitosamente!");
        document.getElementById('crearTrabajador').reset(); // Limpiar formulario

    } catch (error) {
        alert(`Error: ${error.message}`);
        console.error("Error al crear trabajador:", error);
    }
}

        async function convertirImagenABase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]); // Quitar prefijo "data:image/..."
    reader.readAsDataURL(file);
  });
}
        
    </script>
</body>
</html>
