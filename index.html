<!DOCTYPE html>
<html lang="es">
<head>
<link rel="manifest" href="manifest.json">
     <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>AMA PLUS LOGISTICS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <style>
        /* Estilos CSS mejorados */
        .tabs {
            margin: 20px 0;
            gap: 10px;
            display: none;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #map {
            height: 70vh;
            width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #loginModal div {
            background: white;
            width: 300px;
            padding: 20px;
            border-radius: 8px;
        }
        #loginModal input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        #loginModal button {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #loginModal button:hover {
            background: #1d4ed8;
        }
        .info-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .nomina-panel {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            #map {
                height: 60vh;
                margin: 10px 0;
            }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2563eb;
            color: white;
        }
        #logoutBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }
        #logoutBtn:hover {
            background: #b91c1c;
        }
        .upload-section {
            margin: 15px;
            padding: 15px;
            background: #e2e8f0;
            border-radius: 8px;
        }
        .programacion-table {
            margin-top: 20px;
        }
        .confirmar-btn {
            padding: 5px 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirmado {
            background: #34d399;
        }
        .programacion-panel {
            display: none;
        }
        .rechazar-btn {
            padding: 5px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .notificaciones-panel {
            margin: 15px;
            padding: 15px;
            background: #fecaca;
            border-radius: 8px;
        }
        .notificacion-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-wrapper {
            display: none;
        }
         #compartiendo-ubicacion {
    width: 100%;
    margin-top: 10px;
    border-collapse: collapse;
}

#compartiendo-ubicacion th, #compartiendo-ubicacion td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

#compartiendo-ubicacion th {
    background-color: #2563eb;
    color: white;
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
</head>
<body>
    <button id="logoutBtn" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
    <div id="loginModal">
        <div>
            <h2>üîê Inicio de Sesi√≥n</h2>
            <input type="text" id="username" name="username" placeholder="Usuario" autocomplete="username">
            <input type="password" id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password">
            <button onclick="login(event)">Ingresar</button>
        </div>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('programacion', event)">üìÖ Programaci√≥n</button>
        <button class="tab-btn" onclick="openTab('mapa', event)">üó∫Ô∏è Mapa</button>
        <button class="tab-btn" onclick="openTab('sedes', event)">üè¢ Sedes</button>
        <button class="tab-btn" onclick="openTab('trabajadores', event)">üë∑ Trabajadores</button>
    </div>
    <div class="content-wrapper">
        <!-- Panel para administradores -->
        <div class="info-panel">
            <div id="programacion" class="tab-content active">
                <div class="upload-section">
                    <h3>üì§ Subir Programaci√≥n</h3>
                    <input type="file" id="excelProgramacion" accept=".xlsx, .xls">
                    <button onclick="procesarProgramacion()">Cargar Programaci√≥n</button>
                    <div id="programacionData"></div>
                </div>
                <div class="notificaciones-panel">
                    <h3>üö® Notificaciones</h3>
                    <div id="listaNotificaciones"></div>
                </div>
            </div>
<div id="mapa" class="tab-content">
    <div id="map"></div>
    <table id="compartiendo-ubicacion">
        <tbody></tbody>
    </table>
</div>
            <div id="sedes" class="tab-content">
                <div class="upload-section">
                    <h3>üì§ Subir Sedes</h3>
                    <input type="file" id="excelSedes" accept=".xlsx, .xls">
                    <button onclick="procesarSedes()">Cargar Sedes</button>
                </div>
                <div id="listaSedes"></div>
            </div>
        </div>

        <div id="trabajadores" class="tab-content"> <!-- Nuevo tab -->
            <div class="upload-section">
                 <div id="crearTrabajador" class="upload-section">
    <h3>üÜï Crear Trabajador</h3>
<input type="text" id="nombreTrabajador" placeholder="Nombre del Trabajador">
<input type="text" id="documentoTrabajador" placeholder="N√∫mero de Documento">
<input type="text" id="celularTrabajador" placeholder="N√∫mero de Celular">
<button onclick="crearTrabajador()">Agregar Trabajador</button>
</div>
<div id="listaTrabajadores">
    <h3>üë∑ Lista de Trabajadores</h3>
    <ul id="trabajadoresList"></ul>
</div>
                <h3>üì§ Importar Trabajadores</h3>
                <input type="file" id="excelTrabajadores" accept=".xlsx, .xls">
                <button onclick="procesarTrabajadores()">Cargar Trabajadores</button>
            </div>
            <div class="asignacion-section">
                <h3>üîó Asignar Sedes</h3>
                <select id="selectTrabajador">
                    <option value="">Seleccionar Trabajador</option>
                </select>
                <select id="selectSede">
                    <option value="">Seleccionar Sede</option>
                </select>
                <button onclick="asignarSede()">Asignar Sede</button>
            </div>
            <div id="listaTrabajadores"></div>
        </div>
    </div>
        
        <!-- Panel para trabajadores -->
        <div class="nomina-panel">
            <div class="programacion-panel">
                <h3>üìÖ Turnos Asignados</h3>
                <table id="turnosTrabajador">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Turno</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h2>üìÖ Liquidaci√≥n de N√≥mina</h2>
            <div id="nomina-info">
                <p>Usuario: <span id="nombre-trabajador"></span></p>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Horas Trabajadas</th>
                            <th>Valor por Hora</th>
                            <th>Total D√≠a</th>
                        </tr>
                    </thead>
                    <tbody id="registro-nomina"></tbody>
                </table>
                <p style="margin-top: 15px; font-weight: bold;">
                    Total a pagar: $<span id="total-pagar">0</span>
                </p>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script>

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('App funciona offline'))
      .catch(err => console.log('Error:', err));
  }
        
        // Variables globales
        let map;
        let sedes = [];
        let usuarioActual = null;
        let userMarker = null;
        let accuracyCircle = null;
        let trabajadoresMarkers = {};
        let sedeAssignments = {};
          const url = 'https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/trabajadores.json';
        
        const USUARIOS = {
            administradores: {
                'WENDY': {password: 'WENDY123!', role: 'admin'},
                'LAURA': {password: 'LAURA456@', role: 'admin'},
                'JOSE': {password: 'JOSE789#', role: 'admin'},
                'ANDRES': {password: 'ANDRES012$', role: 'admin'},
                'FABIO': {password: 'FABIO345%', role: 'admin'},
                'CRISTIAN': {password: 'CRISTIAN678^', role: 'admin'}
            },
            trabajadores: {
                'PRUEBA': {
                    password: 'PRUEBA123',
                    role: 'worker',
                    nomina: [
                        { fecha: '2023-10-01', horas: 8, valorHora: 15000 },
                        { fecha: '2023-10-02', horas: 6, valorHora: 15000 },
                        { fecha: '2023-10-03', horas: 7, valorHora: 15000 }
                    ]
                }
            }
        };

        const CONFIG = {
            destino: {
                lat: 4.688636,
                lng: -74.132025,
                radio: 170
            },
            opcionesMapa: {
                zoomInicial: 15,
                maxZoom: 19
            },
            estilos: {
                precision: {
                    color: '#3b82f6',
                    relleno: 0.2,
                    escala: 0.5
                }
            }
        };

async function guardarEnRepositorio(rutaArchivo, contenido) {
    const repo = 'barrasck/app-trabajador';
    const branch = 'main';

    let sha;
    try {
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/${rutaArchivo}?ref=${branch}`);
        if (response.ok) {
            const data = await response.json();
            sha = data.sha; // Obtener el SHA si el archivo ya existe
        }
    } catch (error) {
        console.error('Error al obtener el SHA del archivo:', error);
    }

    try {
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/${rutaArchivo}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`, // Reemplaza con tu token v√°lido
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Actualizaci√≥n de ${rutaArchivo}`,
                content: btoa(contenido), // Codificar el contenido en Base64
                branch: branch,
                sha: sha // Incluir el SHA si el archivo ya existe
            })
        });

        if (response.ok) {
            console.log('Archivo guardado en el repositorio');
        } else {
            console.error('Error al guardar el archivo en el repositorio:', response.statusText);
        }
    } catch (error) {
        console.error('Error al guardar el archivo en el repositorio:', error);
    }
}

        function cerrarSesion() {
            sessionStorage.removeItem('session');
            usuarioActual = null;
            document.querySelector('.content-wrapper').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            if(map) {
                map.remove();
                map = null;
                userMarker = null;
                accuracyCircle = null;
            }
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

         
async function login(event) {
    event.preventDefault();
    const username = document.getElementById('username').value.toUpperCase();
    const password = document.getElementById('password').value;

    try {
        // Obtener trabajadores desde el repositorio
        const trabajadoresImportadosResponse = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/trabajadores.json');
        if (!trabajadoresImportadosResponse.ok) {
            throw new Error('No se pudo obtener el archivo trabajadores.json');
        }
        const trabajadoresImportados = await trabajadoresImportadosResponse.json();
        const USUARIOS_COMBINADOS = {
            ...USUARIOS,
            trabajadores: { ...USUARIOS.trabajadores, ...trabajadoresImportados }
        };

        // Validar usuario
        const user = USUARIOS_COMBINADOS.administradores[username] || USUARIOS_COMBINADOS.trabajadores[username];

        if (user && user.password === password) {
            usuarioActual = {
                username: username,
                role: user.role,
                datos: user
            };

            // Mostrar contenido seg√∫n el rol del usuario
            document.getElementById('loginModal').style.display = 'none';
            document.querySelector('.content-wrapper').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            sessionStorage.setItem('session', JSON.stringify(usuarioActual));

            actualizarUI();

            if (usuarioActual.role === 'admin') {
                inicializarMapa(); // Inicializa el mapa
                cargarUbicacionesTrabajadores(); // Carga ubicaciones de los trabajadores
                cargarNotificaciones(); // Carga las notificaciones para admin
            } else if (usuarioActual.role === 'worker') {
                mostrarNomina(); // Muestra n√≥mina del trabajador
                iniciarTrackingTrabajador(); // Inicia el rastreo en tiempo real
                cargarProgramacionTrabajador(); // Carga los turnos asignados

                // Ajustar vistas para trabajadores
                document.querySelector('.tabs').style.display = 'none';
                document.querySelector('.nomina-panel').style.display = 'block';
                document.getElementById('mapa').style.display = 'none';
                document.getElementById('sedes').style.display = 'none';
                document.querySelector('.notificaciones-panel').style.display = 'none';
                document.querySelector('.upload-section').style.display = 'none';

                console.log("Tracking iniciado para el trabajador:", usuarioActual.username);
            }
        } else {
            alert('Credenciales incorrectas');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('username').focus();
        }
    } catch (error) {
        console.error('Error durante el inicio de sesi√≥n:', error);
        alert('Ocurri√≥ un error durante el inicio de sesi√≥n. Revisa la consola para m√°s detalles.');
    }
}
         
function inicializarMapa() {
    try {
        if (!map) {
            // Inicializar el mapa con configuraciones predeterminadas
            map = L.map('map', {
                maxZoom: CONFIG.opcionesMapa.maxZoom
            }).setView([CONFIG.destino.lat, CONFIG.destino.lng], CONFIG.opcionesMapa.zoomInicial);

            // Agregar las capas de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            console.log("Mapa inicializado correctamente.");

            // Cargar ubicaciones de trabajadores y actualizar la tabla inicialmente
            cargarUbicacionesTrabajadores()
                .then(ubicaciones => {
                    if (ubicaciones && Object.keys(ubicaciones).length > 0) {
                        actualizarTablaUbicaciones(ubicaciones);
                        actualizarMapaTrabajadores(ubicaciones);
                        console.log("Ubicaciones de trabajadores cargadas y actualizadas en el mapa.");
                    } else {
                        console.warn("No se encontraron ubicaciones de trabajadores.");
                    }
                })
                .catch(error => {
                    console.error("Error al cargar las ubicaciones de los trabajadores:", error);
                });

            // Actualizar sedes en el mapa
            actualizarSedesEnMapa()
                .then(() => {
                    console.log("Sedes actualizadas en el mapa.");
                })
                .catch(error => {
                    console.error("Error al actualizar las sedes en el mapa:", error);
                });

            // **Agregar el intervalo para actualizar las ubicaciones peri√≥dicamente**
            setInterval(async () => {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/main/ubicaciones.json');
                    if (!response.ok) {
                        throw new Error(`Error al cargar ubicaciones: ${response.statusText}`);
                    }
                    const ubicaciones = await response.json();
                    actualizarTablaUbicaciones(ubicaciones); // Actualiza la tabla de ubicaciones
                    actualizarMapaTrabajadores(ubicaciones); // Refresca los marcadores en el mapa
                    console.log("Ubicaciones actualizadas en tiempo real.");
                } catch (error) {
                    console.error("Error al actualizar las ubicaciones en el mapa:", error);
                }
            }, 10000); // Actualizar cada 10 segundos
        } else {
            console.log("El mapa ya est√° inicializado.");
        }
    } catch (error) {
        console.error("Error al inicializar el mapa:", error);
    }
}


function actualizarMapaTrabajadores(ubicaciones) {
    if (!map) {
        console.error("El mapa no est√° inicializado.");
        return;
    }

    // Mantener un registro de trabajadores procesados para detectar obsoletos
    const procesados = new Set();

    // Iterar sobre las ubicaciones recibidas
    Object.keys(ubicaciones).forEach(trabajadorKey => {
        const ubicacion = ubicaciones[trabajadorKey];

        // Validar que la ubicaci√≥n tenga latitud y longitud
        if (!ubicacion || typeof ubicacion.lat !== 'number' || typeof ubicacion.lng !== 'number') {
            console.warn(`Ubicaci√≥n inv√°lida para el trabajador: ${trabajadorKey}`, ubicacion);
            return;
        }

        const marker = trabajadoresMarkers[trabajadorKey];
        procesados.add(trabajadorKey); // Marcar como procesado

        if (marker) {
            // Actualizar la posici√≥n del marcador existente solo si la ubicaci√≥n cambi√≥
            if (
                marker.getLatLng().lat !== ubicacion.lat ||
                marker.getLatLng().lng !== ubicacion.lng
            ) {
                marker.setLatLng([ubicacion.lat, ubicacion.lng])
                    .setPopupContent(`Trabajador: ${ubicacion.nombre || trabajadorKey}`);
                console.log(`Ubicaci√≥n actualizada para el trabajador: ${trabajadorKey}`);
            }
        } else {
            // Crear un nuevo marcador si no existe
            trabajadoresMarkers[trabajadorKey] = L.marker([ubicacion.lat, ubicacion.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    iconSize: [25, 41],
                }),
            }).addTo(map).bindPopup(`Trabajador: ${ubicacion.nombre || trabajadorKey}`);
            console.log(`Marcador creado para el trabajador: ${trabajadorKey}`);
        }
    });

    // Eliminar marcadores obsoletos (trabajadores que ya no est√°n en ubicaciones)
    Object.keys(trabajadoresMarkers).forEach(trabajadorKey => {
        if (!procesados.has(trabajadorKey)) {
            map.removeLayer(trabajadoresMarkers[trabajadorKey]);
            delete trabajadoresMarkers[trabajadorKey];
            console.log(`Marcador eliminado para el trabajador: ${trabajadorKey}`);
        }
    });
}

// Refrescar el mapa autom√°ticamente a intervalos definidos (por ejemplo, cada 10 segundos)
setInterval(async () => {
    try {
        const ubicacionesResponse = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/ubicaciones.json');
        if (!ubicacionesResponse.ok) {
            throw new Error(`Error al cargar las ubicaciones: ${ubicacionesResponse.statusText}`);
        }

        const ubicaciones = await ubicacionesResponse.json();
        actualizarMapaTrabajadores(ubicaciones);
    } catch (error) {
        console.error("Error al actualizar los trabajadores en el mapa:", error);
    }
}, 10000); // Intervalo de 10 segundos

// Funci√≥n principal para actualizar el mapa con las ubicaciones de los trabajadores
async function actualizarMapaTrabajadores() {
    try {
        // Obtener las ubicaciones desde el archivo remoto
        const ubicacionesResponse = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/ubicaciones.json');
        if (!ubicacionesResponse.ok) {
            throw new Error(`Error al cargar las ubicaciones: ${ubicacionesResponse.statusText}`);
        }

        const ubicaciones = await ubicacionesResponse.json();

        if (!map) {
            console.error("El mapa no est√° inicializado.");
            return;
        }

        // Mantener un registro de trabajadores procesados para detectar obsoletos
        const procesados = new Set();

        // Iterar sobre las ubicaciones recibidas
        Object.keys(ubicaciones).forEach(trabajadorKey => {
            const ubicacion = ubicaciones[trabajadorKey];

            // Validar que la ubicaci√≥n tenga latitud y longitud
            if (!ubicacion || typeof ubicacion.lat !== 'number' || typeof ubicacion.lng !== 'number') {
                console.warn(`Ubicaci√≥n inv√°lida para el trabajador: ${trabajadorKey}`, ubicacion);
                return;
            }

            const marker = trabajadoresMarkers[trabajadorKey];
            procesados.add(trabajadorKey); // Marcar como procesado

            if (marker) {
                // Actualizar la posici√≥n del marcador existente solo si la ubicaci√≥n cambi√≥
                if (
                    marker.getLatLng().lat !== ubicacion.lat ||
                    marker.getLatLng().lng !== ubicacion.lng
                ) {
                    marker.setLatLng([ubicacion.lat, ubicacion.lng])
                        .setPopupContent(`Trabajador: ${ubicacion.nombre || trabajadorKey}`);
                    console.log(`Ubicaci√≥n actualizada para el trabajador: ${trabajadorKey}`);
                }
            } else {
                // Crear un nuevo marcador si no existe
                trabajadoresMarkers[trabajadorKey] = L.marker([ubicacion.lat, ubicacion.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        iconSize: [25, 41],
                    }),
                }).addTo(map).bindPopup(`Trabajador: ${ubicacion.nombre || trabajadorKey}`);
                console.log(`Marcador creado para el trabajador: ${trabajadorKey}`);
            }
        });

        // Eliminar marcadores obsoletos (trabajadores que ya no est√°n en ubicaciones)
        Object.keys(trabajadoresMarkers).forEach(trabajadorKey => {
            if (!procesados.has(trabajadorKey)) {
                map.removeLayer(trabajadoresMarkers[trabajadorKey]);
                delete trabajadoresMarkers[trabajadorKey];
                console.log(`Marcador eliminado para el trabajador: ${trabajadorKey}`);
            }
        });

        // Actualizar la tabla de ubicaciones en el DOM
        actualizarTablaUbicaciones(ubicaciones);
    } catch (error) {
        console.error("Error al actualizar los trabajadores en el mapa:", error);
    }
}

// Funci√≥n auxiliar para actualizar la tabla de ubicaciones
function actualizarTablaUbicaciones(ubicaciones) {
    try {
        const tablaElement = document.getElementById('compartiendo-ubicacion');
        if (!tablaElement) {
            console.warn('El elemento #compartiendo-ubicacion no existe en el DOM.');
            return;
        }

        const tbody = tablaElement.querySelector('tbody');
        if (!tbody) {
            console.warn('El elemento <tbody> dentro de #compartiendo-ubicacion no existe.');
            return;
        }

        // Limpiar contenido anterior de la tabla
        tbody.innerHTML = '';

        // Verificar si hay ubicaciones v√°lidas para mostrar
        if (!ubicaciones || Object.keys(ubicaciones).length === 0) {
            console.info('No se encontraron ubicaciones para mostrar en la tabla.');
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="3">No hay ubicaciones disponibles</td>`;
            tbody.appendChild(row);
            return;
        }

        // Iterar sobre las ubicaciones y actualizar la tabla
        Object.keys(ubicaciones).forEach(trabajadorKey => {
            const ubicacion = ubicaciones[trabajadorKey];
            const row = document.createElement('tr');

            if (ubicacion && ubicacion.lat && ubicacion.lng) {
                // Fila para un trabajador con ubicaci√≥n v√°lida
                row.innerHTML = `
                    <td>${trabajadorKey}</td>
                    <td>Lat: ${ubicacion.lat.toFixed(5)}</td>
                    <td>Lng: ${ubicacion.lng.toFixed(5)}</td>
                `;
            } else {
                // Fila para un trabajador con ubicaci√≥n inv√°lida o faltante
                console.warn(`La ubicaci√≥n del trabajador ${trabajadorKey} es inv√°lida o incompleta.`);
                row.innerHTML = `
                    <td>${trabajadorKey}</td>
                    <td colspan="2">Ubicaci√≥n no disponible</td>
                `;
            }

            tbody.appendChild(row);
        });

        console.log('Tabla de ubicaciones actualizada correctamente.');
    } catch (error) {
        console.error('Error al actualizar la tabla de ubicaciones:', error);
    }
}

// Refrescar el mapa autom√°ticamente a intervalos definidos (por ejemplo, cada 10 segundos)
setInterval(() => {
    actualizarMapaTrabajadores();
}, 10000); // Actualizar cada 10 segundos
async function cargarTrabajadores() {
    try {
        // Utiliza la URL RAW de GitHub para evitar problemas de CORS
        const response = await fetch('https://raw.githubusercontent.com/barrasck/app-trabajador/refs/heads/main/trabajadores.json');
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        // Parsear el JSON obtenido
        const trabajadores = await response.json();
        console.log('Trabajadores cargados:', trabajadores);

        // Muestra los trabajadores en la interfaz
        const lista = document.getElementById('trabajadoresList');
        lista.innerHTML = ''; // Limpia el contenido previo

        // Verificar si hay trabajadores en los datos cargados
        const trabajadoresArray = Object.values(trabajadores);
        if (trabajadoresArray.length === 0) {
            lista.innerHTML = '<li>No hay trabajadores registrados.</li>';
            return;
        }

        // Iterar sobre los valores del objeto trabajadores
        trabajadoresArray.forEach(trabajador => {
            // Validar que los campos necesarios est√©n presentes
            if (!trabajador.nombre || !trabajador.documento) {
                console.warn(`Trabajador con datos incompletos:`, trabajador);
                return; // Ignorar trabajadores con datos incompletos
            }

            const li = document.createElement('li');
            li.textContent = `${trabajador.nombre} - Documento: ${trabajador.documento}`;
            lista.appendChild(li);
        });
    } catch (error) {
        console.error('Error al cargar los trabajadores:', error);
        alert('No se pudieron cargar los trabajadores. Por favor, verifica tu conexi√≥n o el archivo JSON.');
    }
}

// Llama a la funci√≥n para cargar trabajadores
cargarTrabajadores();

async function procesarTrabajadores() {
    const file = document.getElementById('excelTrabajadores').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            // Validar columnas requeridas
            if (!jsonData[0]?.['N√∫mero de Documento'] || !jsonData[0]?.Nombre || !jsonData[0]?.['N√∫mero de Celular']) {
                throw new Error("Formato incorrecto. Columnas requeridas: N√∫mero de Documento, Nombre, N√∫mero de Celular");
            }

            const trabajadores = jsonData.reduce((acc, t) => {
                const documento = t['N√∫mero de Documento'];
                acc[documento] = {
                    password: documento,
                    role: 'worker',
                    documento: documento,
                    nombre: t['Nombre'],
                    celular: t['N√∫mero de Celular'],
                    nomina: []
                };
                return acc;
            }, {});

            await guardarEnRepositorio('trabajadores.json', JSON.stringify(trabajadores, null, 2));
            actualizarListaTrabajadores();
            alert("Trabajadores importados y guardados exitosamente!");
        } catch (error) {
            alert(error.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

         let trabajadores = {}; // Almac√©n local de trabajadores

function crearTrabajador() {
    const nombre = document.getElementById('nombreTrabajador').value;
    const documento = document.getElementById('documentoTrabajador').value;
    const celular = document.getElementById('celularTrabajador').value;

    if (!nombre || !documento || !celular) {
        alert("Por favor, completa todos los campos.");
        return;
    }

    // Agregar trabajador al objeto global
    trabajadores[documento] = {
        nombre: nombre,
        documento: documento,
        celular: celular,
        role: 'worker',
        nomina: []
    };

    // Actualizar la lista visual
    actualizarListaTrabajadores();

    // Limpiar el formulario
    document.getElementById('nombreTrabajador').value = '';
    document.getElementById('documentoTrabajador').value = '';
    document.getElementById('celularTrabajador').value = '';

    alert("Trabajador agregado exitosamente.");
}

async function actualizarListaTrabajadores() {
    // Obtener trabajadores desde el repositorio remoto
    const response = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/trabajadores.json?ref=main');
    const data = await response.json();
    const trabajadores = JSON.parse(atob(data.content));

    // Obtener sedes desde el repositorio remoto
    const sedesResponse = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/sedes.json?ref=main');
    const sedesData = await sedesResponse.json();
    const sedes = JSON.parse(atob(sedesData.content));

    // Actualizar selects
    const selectTrabajador = document.getElementById('selectTrabajador');
    const selectSede = document.getElementById('selectSede');

    selectTrabajador.innerHTML = '<option value="">Seleccionar Trabajador</option>';
    selectSede.innerHTML = '<option value="">Seleccionar Sede</option>';

    Object.keys(trabajadores).forEach(t => {
        selectTrabajador.innerHTML += `<option value="${t}">${trabajadores[t].nombre}</option>`;
    });

    sedes.forEach(s => {
        selectSede.innerHTML += `<option value="${s.Nombre}">${s.Nombre}</option>`;
    });

    // Actualizar la lista visual de trabajadores
    const lista = document.getElementById('trabajadoresList'); // Seleccionar el `<ul>`
    lista.innerHTML = ''; // Limpiar el contenido previo

    Object.keys(trabajadores).forEach((documento) => {
        const trabajador = trabajadores[documento];
        const li = document.createElement('li'); // Crear un nuevo elemento de lista
        li.textContent = `${trabajador.nombre} (Documento: ${trabajador.documento}, Celular: ${trabajador.celular})`;
        lista.appendChild(li); // Agregar el elemento a la lista
    });
}
async function guardarTrabajadoresEnRepositorio() {
    const contenido = btoa(JSON.stringify(trabajadores, null, 2)); // Codificar en Base64
    const repo = 'barrasck/app-trabajador';
    const path = 'trabajadores.json';
    const branch = 'main';
    const mensaje = 'Actualizaci√≥n de trabajadores';

    let sha;
    try {
        // **Este bloque verifica si el archivo ya existe y obtiene el SHA**
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`);
        if (response.ok) {
            const data = await response.json();
            sha = data.sha;
        }
    } catch (error) {
        console.warn('El archivo no existe, se crear√° uno nuevo.');
    }

    try {
        // Guardar el archivo actualizado
        const resultado = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer <tu-token-de-acceso>`, // Aseg√∫rate de usar un token de acceso v√°lido
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: mensaje,
                content: contenido,
                branch: branch,
                sha: sha, // Incluye el SHA si existe
            }),
        });

        if (resultado.ok) {
            alert('Trabajadores guardados en el repositorio.');
        } else {
            alert('Error al guardar los trabajadores.');
        }
    } catch (error) {
        console.error('Error al guardar los trabajadores:', error);
    }
}

async function asignarSede() {
    const trabajador = document.getElementById('selectTrabajador').value;
    const sede = document.getElementById('selectSede').value;

    if (!trabajador || !sede) {
        alert("Seleccione un trabajador y una sede");
        return;
    }

    const response = await fetch('https://api.github.com/repos/barrasck/ubicacion/contents/asignaciones.json?ref=main');
    const data = await response.json();
    const asignaciones = JSON.parse(atob(data.content));

    asignaciones[trabajador] = sede;
    await guardarEnRepositorio('asignaciones.json', JSON.stringify(asignaciones, null, 2));
    alert("Sede asignada exitosamente!");
}

async function iniciarTrackingTrabajador() {
    if (navigator.geolocation && usuarioActual.role === 'worker') {
        console.log("Iniciando rastreo de ubicaci√≥n en tiempo real para el usuario:", usuarioActual.username);

        // Mantener un intervalo para verificar y actualizar ubicaciones
        const intervaloActualizacion = 10000; // Actualizar cada 10 segundos
        let ultimaUbicacion = null;

        navigator.geolocation.watchPosition(
            async position => {
                const ubicacion = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    timestamp: new Date().toISOString()
                };

                console.log("Ubicaci√≥n obtenida en tiempo real:", ubicacion);

                // Evitar actualizaciones innecesarias si no hay cambios significativos
                if (ultimaUbicacion &&
                    ultimaUbicacion.lat === ubicacion.lat &&
                    ultimaUbicacion.lng === ubicacion.lng) {
                    console.log("La ubicaci√≥n no ha cambiado significativamente, no se actualiza.");
                    return;
                }

                ultimaUbicacion = ubicacion; // Actualizar la √∫ltima ubicaci√≥n

                try {
                    // Obtener ubicaciones actuales desde el archivo remoto
                    const response = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/ubicaciones.json?ref=main');
                    if (!response.ok) {
                        throw new Error(`Error al cargar ubicaciones: ${response.status} - ${response.statusText}`);
                    }

                    const data = await response.json();
                    const ubicaciones = JSON.parse(atob(data.content));

                    // Validar el formato del archivo de ubicaciones
                    if (!ubicaciones || typeof ubicaciones !== 'object') {
                        throw new Error('El archivo ubicaciones.json no tiene un formato v√°lido.');
                    }

                    // Actualizar la ubicaci√≥n del trabajador actual
                    ubicaciones[usuarioActual.username] = ubicacion;

                    // Guardar la nueva ubicaci√≥n en el repositorio
                    await guardarEnRepositorio('ubicaciones.json', JSON.stringify(ubicaciones, null, 2));
                    console.log("Ubicaci√≥n actualizada en el repositorio para el usuario:", usuarioActual.username);
                } catch (error) {
                    console.error('Error al actualizar la ubicaci√≥n del trabajador:', error);
                }
            },
            error => {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        console.error("El usuario deneg√≥ el acceso a la ubicaci√≥n.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.error("La informaci√≥n de ubicaci√≥n no est√° disponible.");
                        break;
                    case error.TIMEOUT:
                        console.error("El tiempo de espera para obtener la ubicaci√≥n se agot√≥.");
                        break;
                    default:
                        console.error("Ocurri√≥ un error desconocido al obtener la ubicaci√≥n:", error.message);
                        break;
                }
            },
            {
                enableHighAccuracy: true, // Alta precisi√≥n
                maximumAge: 5000,        // M√°ximo 5 segundos de cach√©
                timeout: 20000           // Tiempo de espera de 20 segundos
            }
        );

        // Actualizaci√≥n peri√≥dica del repositorio
        setInterval(async () => {
            if (!ultimaUbicacion) {
                console.warn("No se ha registrado ninguna ubicaci√≥n nueva para actualizar.");
                return;
            }

            try {
                const response = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/ubicaciones.json?ref=main');
                const data = await response.json();
                const ubicaciones = JSON.parse(atob(data.content));

                // Actualizar solo si la √∫ltima ubicaci√≥n es v√°lida
                ubicaciones[usuarioActual.username] = ultimaUbicacion;

                // Guardar en el repositorio
                await guardarEnRepositorio('ubicaciones.json', JSON.stringify(ubicaciones, null, 2));
                console.log("Ubicaci√≥n peri√≥dica actualizada para el usuario:", usuarioActual.username);
            } catch (error) {
                console.error("Error al actualizar peri√≥dicamente la ubicaci√≥n:", error);
            }
        }, intervaloActualizacion);
    } else {
        console.warn("El navegador no soporta geolocalizaci√≥n o el usuario no tiene permisos.");
    }
}

function actualizarUI() {
    if (usuarioActual.role === 'admin') {
        document.querySelector('.tabs').style.display = 'flex';
        document.querySelector('.content-wrapper').style.display = 'block';
        document.querySelector('.nomina-panel').style.display = 'none';
        openTab('programacion', { currentTarget: document.querySelector('.tab-btn.active') });
    } else if (usuarioActual.role === 'worker') {
        document.querySelector('.tabs').style.display = 'none';
        document.querySelector('.nomina-panel').style.display = 'block';
        document.getElementById('mapa').style.display = 'none';
        document.getElementById('sedes').style.display = 'none';
    }
}

        function mostrarNomina() {
            const trabajador = usuarioActual.datos;
            const tbody = document.getElementById('registro-nomina');
            let total = 0;
            document.getElementById('nombre-trabajador').textContent = trabajador.username;
            tbody.innerHTML = '';
            trabajador.nomina.forEach(dia => {
                const totalDia = dia.horas * dia.valorHora;
                total += totalDia;
                tbody.innerHTML += `
                    <tr>
                        <td>${dia.fecha}</td>
                        <td>${dia.horas}</td>
                        <td>$${dia.valorHora.toLocaleString()}</td>
                        <td>$${totalDia.toLocaleString()}</td>
                    </tr>
                `;
            });
            document.getElementById('total-pagar').textContent = total.toLocaleString();
        }

        function iniciarGeolocalizacion() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    manejarPosicion,
                    (error) => {
                        console.error(`Error de geolocalizaci√≥n (${error.code}): ${error.message}`);
                        document.getElementById('status').innerHTML = "‚ùå Error al obtener ubicaci√≥n";
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 30000
                    }
                );
            } else {
                document.getElementById('status').innerHTML = "‚ùå Tu navegador no soporta geolocalizaci√≥n";
            }
        }

function manejarPosicion(position) {
    if (!map) {
        console.error("El mapa no est√° inicializado.");
        return;
    }

    const userCoords = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy
    };
    const coordinatesElement = document.getElementById('coordinates');
    if (coordinatesElement) {
        coordinatesElement.textContent = `üìå Tus coordenadas: ${userCoords.lat.toFixed(5)}, ${userCoords.lng.toFixed(5)}`;
    }

    if (userMarker) {
        userMarker.setLatLng([userCoords.lat, userCoords.lng]);
    } else {
        userMarker = L.marker([userCoords.lat, userCoords.lng]).addTo(map);
    }
    if (accuracyCircle) {
        accuracyCircle.setLatLng([userCoords.lat, userCoords.lng])
            .setRadius(userCoords.accuracy * CONFIG.estilos.precision.escala);
    } else {
        accuracyCircle = L.circle([userCoords.lat, userCoords.lng], {
            radius: userCoords.accuracy * CONFIG.estilos.precision.escala,
            color: CONFIG.estilos.precision.color,
            fillColor: CONFIG.estilos.precision.color,
            fillOpacity: CONFIG.estilos.precision.relleno,
        }).addTo(map);
    }
}

window.onload = async function() {
    try {
        const session = sessionStorage.getItem('session');
        document.getElementById('logoutBtn').style.display = session ? 'block' : 'none';

        if (!session) {
            document.getElementById('loginModal').style.display = 'flex';
        } else {
            document.querySelector('.content-wrapper').style.display = 'block';
            usuarioActual = JSON.parse(session);
            actualizarUI();

            if (usuarioActual.role === 'admin') {
    inicializarMapa(); // Inicializa el mapa
    cargarUbicacionesTrabajadores(); // Carga ubicaciones de trabajadores
    iniciarGeolocalizacion(); // Inicia la geolocalizaci√≥n para el administrador
    cargarNotificaciones(); // Carga las notificaciones
            } else if (usuarioActual.role === 'worker') {
    mostrarNomina(); // Muestra n√≥mina del trabajador
    iniciarTrackingTrabajador(); // Inicia el env√≠o de ubicaci√≥n
    cargarProgramacionTrabajador(); // Carga los turnos asignados
    document.querySelector('.tabs').style.display = 'none';
    document.querySelector('.nomina-panel').style.display = 'block';
    document.getElementById('mapa').style.display = 'none';
    document.getElementById('sedes').style.display = 'none';
    document.querySelector('.notificaciones-panel').style.display = 'none';
    document.querySelector('.upload-section').style.display = 'none';
            }
        }

        // Cargar trabajadores desde el repositorio
        await cargarTrabajadores();
    } catch (error) {
        console.error('Error durante la inicializaci√≥n:', error);
        alert('Ocurri√≥ un error durante la inicializaci√≥n. Revisa la consola para m√°s detalles.');
    }
};

async function procesarProgramacion() {
    const file = document.getElementById('excelProgramacion').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            // Validar columnas requeridas (incluyendo Sede)
            if (!jsonData[0]?.Sede || !jsonData[0]?.Fecha || !jsonData[0]?.Turno || !jsonData[0]?.Nombre) {
                throw new Error("Formato incorrecto. Columnas requeridas: Sede, Fecha, Turno, Nombre");
            }

            // Validar que la sede exista
            const sedesResponse = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/sedes.json?ref=main');
            const sedesData = await sedesResponse.json();
            const sedesCargadas = JSON.parse(atob(sedesData.content));

            const sedesInvalidas = jsonData.filter(t => 
                !sedesCargadas.some(s => s.Nombre === t.Sede)
            );

            if (sedesInvalidas.length > 0) {
                throw new Error(`Sedes no encontradas: ${sedesInvalidas.map(t => t.Sede).join(', ')}`);
            }

            await guardarEnRepositorio('programacion.json', JSON.stringify(jsonData, null, 2));
            mostrarProgramacionAdmin(jsonData);
            alert("Programaci√≥n cargada exitosamente!");
        } catch (error) {
            alert(error.message);
            console.error(error);
        }
    };
    reader.readAsArrayBuffer(file);
}

        function mostrarProgramacionAdmin(data) {
            const contenedor = document.getElementById('programacionData');
            contenedor.innerHTML = `
                <h4>üìã Programaci√≥n Cargada</h4>
                <table class="programacion-table">
                    <thead>
                        <tr>
                            <th>Sede</th>
                            <th>Nombre</th>
                            <th>Fecha</th>
                            <th>Turno</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.Sede}</td>
                                <td>${row.Nombre}</td>
                                <td>${row.Fecha}</td>
                                <td>${row.Turno}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            contenedor.style.display = 'block';
        }

async function cargarProgramacionTrabajador() {
    const response = await fetch('https://api.github.com/repos/barrasck/ubicacion/contents/programacion.json?ref=main');
    const data = await response.json();
    const programacion = JSON.parse(atob(data.content));

    const turnosUsuario = programacion.filter(t => t.Nombre === usuarioActual.username);
    const tbody = document.querySelector('#turnosTrabajador tbody');

    tbody.innerHTML = turnosUsuario.map(turno => `
        <tr>
            <td>${turno.Fecha}</td>
            <td>${turno.Turno}</td>
            <td>${turno.estado === 'confirmado' ? '‚úÖ Confirmado' : 
                turno.estado === 'rechazado' ? '‚ùå Rechazado' : '‚è≥ Pendiente'}</td>
            <td>
                ${turno.estado !== 'confirmado' ? `
                <button class="confirmar-btn" 
                    onclick="confirmarTurno('${turno.Fecha}')">
                    Confirmar
                </button>
                <button class="rechazar-btn" 
                    onclick="rechazarTurno('${turno.Fecha}')">
                    Rechazar
                </button>` : 'Sin acciones'}
            </td>
        </tr>
    `).join('');
}


async function rechazarTurno(fecha) {
    if (confirm("¬øEst√°s seguro de rechazar este turno?")) {
        const response = await fetch('https://api.github.com/repos/barrasck/ubicacion/contents/programacion.json?ref=main');
        const data = await response.json();
        let programacion = JSON.parse(atob(data.content));

        programacion = await Promise.all(programacion.map(async (t) => {
            if (t.Nombre === usuarioActual.username && t.Fecha === fecha) {
                const turnoRechazado = {
                    ...t,
                    estado: 'rechazado',
                    fechaRechazo: new Date().toISOString()
                };

                // Agregar notificaci√≥n
                const notificacionesResponse = await fetch('https://api.github.com/repos/barrasck/ubicacion/contents/notificaciones.json?ref=main');
                const notificacionesData = await notificacionesResponse.json();
                const notificaciones = JSON.parse(atob(notificacionesData.content));

                notificaciones.push({
                    trabajador: usuarioActual.username,
                    fecha: fecha,
                    turno: t.Turno,
                    timestamp: new Date().toISOString()
                });
                await guardarEnRepositorio('notificaciones.json', JSON.stringify(notificaciones, null, 2));

                return turnoRechazado;
            }
            return t;
        }));

        await guardarEnRepositorio('programacion.json', JSON.stringify(programacion, null, 2));
        cargarProgramacionTrabajador();
        if (usuarioActual.role === 'admin') cargarNotificaciones();
    }
}

async function cargarNotificaciones() {
    try {
        const response = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/notificaciones.json?ref=main');
        if (!response.ok) throw new Error("Error al cargar las notificaciones");

        const data = await response.json();
        const notificaciones = JSON.parse(atob(data.content));
        actualizarUIConNotificaciones(notificaciones); // Llamar a la nueva funci√≥n
    } catch (error) {
        console.error('Error al cargar las notificaciones:', error);
        alert('No se pudieron cargar las notificaciones.');
    }
}

         function actualizarUIConNotificaciones(notificaciones) {
    const listaNotificaciones = document.getElementById('listaNotificaciones');
    listaNotificaciones.innerHTML = ''; // Limpia las notificaciones previas

    notificaciones.forEach(notificacion => {
        const item = document.createElement('div');
        item.className = 'notificacion-item';
        item.innerHTML = `
            <span>${notificacion.mensaje}</span>
            <button onclick="marcarComoLeida('${notificacion.id}')">‚úîÔ∏è</button>
        `;
        listaNotificaciones.appendChild(item);
    });
}

async function marcarComoResuelto(index) {
    const response = await fetch('https://api.github.com/repos/barrasck/ubicacion/contents/notificaciones.json?ref=main');
    const data = await response.json();
    const notificaciones = JSON.parse(atob(data.content));

    notificaciones.splice(index, 1);
    await guardarEnRepositorio('notificaciones.json', JSON.stringify(notificaciones, null, 2));
    cargarNotificaciones();
}

function openTab(tabName, event) {
    if (usuarioActual.role !== 'admin') return;

    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');

    if (tabName === 'mapa') {
        if (!map) {
            inicializarMapa();
        } else {
            map.invalidateSize(); // Recalcula el tama√±o del mapa
        }
    }
}

async function procesarSedes() {
    const file = document.getElementById('excelSedes').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            // Validar columnas requeridas
            if (!jsonData[0]?.['Nombre'] || !jsonData[0]?.['Latitud'] || !jsonData[0]?.['Longitud']) {
                throw new Error("Formato incorrecto. Columnas requeridas: Nombre, Latitud, Longitud");
            }

            await guardarEnRepositorio('sedes.json', JSON.stringify(jsonData, null, 2));
            alert("Sedes importadas y guardadas exitosamente!");
        } catch (error) {
            alert(error.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

async function actualizarSedesEnMapa() {
    if (!map) return;

    try {
        const response = await fetch('https://api.github.com/repos/barrasck/app-trabajador/contents/sedes.json?ref=main');
        if (!response.ok) {
            throw new Error(`Error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const sedes = JSON.parse(atob(data.content));

        // Agrega el console.log aqu√≠:
        console.log('Datos de las sedes:', sedes);

        // Icono rojo para las sedes
        const sedeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });

        // A√±adir sedes al mapa
        sedes.forEach(sede => {
            L.marker([sede.Latitud, sede.Longitud], { icon: sedeIcon })
                .addTo(map)
                .bindPopup(`<b>${sede.Nombre}</b>`);
        });
    } catch (error) {
        console.error('Error al cargar las sedes:', error);
    }
}

        function mostrarListaSedes() {
            const contenedor = document.getElementById('listaSedes');
            contenedor.innerHTML = sedes.map(sede => `
                <div class="sede-item">
                    <h4>${sede.Nombre}</h4>
                    <p>Lat: ${sede.Latitud}, Lng: ${sede.Longitud}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
