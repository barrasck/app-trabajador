<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <title>Seguimiento de Ubicaci√≥n y N√≥mina</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    <style>
        /* Estilos CSS mejorados */
        .tabs {
            margin: 20px 0;
            gap: 10px;
            display: none;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #map {
            height: 70vh;
            width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #loginModal div {
            background: white;
            width: 300px;
            padding: 20px;
            border-radius: 8px;
        }
        #loginModal input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        #loginModal button {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #loginModal button:hover {
            background: #1d4ed8;
        }
        .info-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .nomina-panel {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            #map {
                height: 60vh;
                margin: 10px 0;
            }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2563eb;
            color: white;
        }
        #logoutBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }
        #logoutBtn:hover {
            background: #b91c1c;
        }
        .upload-section {
            margin: 15px;
            padding: 15px;
            background: #e2e8f0;
            border-radius: 8px;
        }
        .programacion-table {
            margin-top: 20px;
        }
        .confirmar-btn {
            padding: 5px 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirmado {
            background: #34d399;
        }
        .programacion-panel {
            display: none;
        }
        .rechazar-btn {
            padding: 5px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .notificaciones-panel {
            margin: 15px;
            padding: 15px;
            background: #fecaca;
            border-radius: 8px;
        }
        .notificacion-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-wrapper {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('App funciona offline'))
                .catch(err => console.log('Error:', err));
        }

        // Variables globales
        let map;
        let sedes = [];
        let usuarioActual = null;
        let userMarker = null;
        let accuracyCircle = null;
        let polyline = null;
        let trabajadoresMarkers = {};
        let sedeAssignments = {};
        let markerCluster;

        const USUARIOS = {
            administradores: {
                'WENDY': {password: 'WENDY123!', role: 'admin'},
                'LAURA': {password: 'LAURA456@', role: 'admin'},
                'JOSE': {password: 'JOSE789#', role: 'admin'},
                'ANDRES': {password: 'ANDRES012$', role: 'admin'},
                'FABIO': {password: 'FABIO345%', role: 'admin'},
                'CRISTIAN': {password: 'CRISTIAN678^', role: 'admin'}
            },
            trabajadores: {
                'PRUEBA': {
                    password: 'PRUEBA123',
                    role: 'worker',
                    nomina: [
                        { fecha: '2023-10-01', horas: 8, valorHora: 15000 },
                        { fecha: '2023-10-02', horas: 6, valorHora: 15000 },
                        { fecha: '2023-10-03', horas: 7, valorHora: 15000 }
                    ]
                }
            }
        };

        const CONFIG = {
            destino: {
                lat: 4.688636,
                lng: -74.132025,
                radio: 170
            },
            opcionesMapa: {
                zoomInicial: 15,
                maxZoom: 19
            },
            estilos: {
                lineaConexion: {
                    color: '#2563eb',
                    peso: 3,
                    opacidad: 0.7
                },
                precision: {
                    color: '#3b82f6',
                    relleno: 0.2,
                    escala: 0.5
                }
            }
        };

        function cerrarSesion() {
            sessionStorage.removeItem('session');
            usuarioActual = null;
            document.querySelector('.content-wrapper').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            if(map) {
                map.remove();
                map = null;
                userMarker = null;
                accuracyCircle = null;
                polyline = null;
                if (markerCluster) {
                    markerCluster.clearLayers();
                    markerCluster = null;
                }
            }
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function inicializarMapa() {
            if (!map) {
                map = L.map('map', {
                    preferCanvas: true, // Usar canvas para mejorar el rendimiento
                    maxZoom: CONFIG.opcionesMapa.maxZoom
                }).setView([CONFIG.destino.lat, CONFIG.destino.lng], CONFIG.opcionesMapa.zoomInicial);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                const destinoIcon = L.icon({
                    iconUrl: './marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });
                L.marker([CONFIG.destino.lat, CONFIG.destino.lng], { icon: destinoIcon })
                    .addTo(map)
                    .bindPopup('<b>Punto de Destino</b><br>Bogot√° D.C.')
                    .openPopup();

                // Inicializar el cluster de marcadores
                markerCluster = L.markerClusterGroup();
                map.addLayer(markerCluster);

                if (usuarioActual.role === 'admin') {
                    cargarUbicacionesTrabajadores();
                }
            }
        }

        function cargarUbicacionesTrabajadores() {
            const ubicaciones = JSON.parse(localStorage.getItem('ubicaciones')) || {};
            const asignaciones = JSON.parse(localStorage.getItem('asignaciones')) || {};
            const sedes = JSON.parse(localStorage.getItem('sedes')) || [];

            Object.keys(ubicaciones).forEach(trabajador => {
                const ubicacion = ubicaciones[trabajador];
                const sedeAsignada = sedes.find(s => s.Nombre === asignaciones[trabajador]);

                if(trabajadoresMarkers[trabajador]) {
                    trabajadoresMarkers[trabajador].setLatLng([ubicacion.lat, ubicacion.lng]);
                } else {
                    const marker = L.marker([ubicacion.lat, ubicacion.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            iconSize: [25, 41]
                        })
                    });

                    let popupContent = `<b>${trabajador}</b><br>√öltima actualizaci√≥n: ${new Date(ubicacion.timestamp).toLocaleTimeString()}`;

                    if(sedeAsignada) {
                        popupContent += `<br>Sede asignada: ${sedeAsignada.Nombre}`;
                        L.polyline([[ubicacion.lat, ubicacion.lng], [sedeAsignada.Latitud, sedeAsignada.Longitud]], {
                            color: 'gray',
                            dashArray: '5'
                        }).addTo(map);
                    }

                    marker.bindPopup(popupContent);
                    trabajadoresMarkers[trabajador] = marker;
                    markerCluster.addLayer(marker); // A√±adir al cluster de marcadores
                }
            });
        }

        // Funci√≥n login √∫nica y completa
        function login() {
            const username = document.getElementById('username').value.toUpperCase();
            const password = document.getElementById('password').value;
            
            // Cargar trabajadores desde localStorage
            const trabajadoresImportados = JSON.parse(localStorage.getItem('trabajadores')) || {};
            const USUARIOS_COMBINADOS = {
                ...USUARIOS,
                trabajadores: {...USUARIOS.trabajadores, ...trabajadoresImportados}
            };

            const user = USUARIOS_COMBINADOS.administradores[username] || USUARIOS_COMBINADOS.trabajadores[username];
            
            if(user && user.password === password) {
                usuarioActual = {
                    username: username,
                    role: user.role,
                    datos: user
                };
                document.getElementById('loginModal').style.display = 'none';
                document.querySelector('.content-wrapper').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
                sessionStorage.setItem('session', JSON.stringify(usuarioActual));
                actualizarUI();

                if(usuarioActual.role === 'admin') {
                    inicializarMapa();
                    iniciarGeolocalizacion();
                    cargarNotificaciones();
                } else {
                    mostrarNomina();
                    cargarProgramacionTrabajador();
                    document.querySelector('.tabs').style.display = 'none';
                    document.querySelector('.nomina-panel').style.display = 'block';
                    document.getElementById('mapa').style.display = 'none';
                    document.getElementById('sedes').style.display = 'none';
                    document.querySelector('.notificaciones-panel').style.display = 'none';
                    document.querySelector('.upload-section').style.display = 'none';
                }

                if(usuarioActual.role === 'worker') {
                    iniciarTrackingTrabajador();
                }
            } else {
                alert('Credenciales incorrectas');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
            }
        }

        // Funci√≥n para procesar archivo de trabajadores
        function procesarTrabajadores() {
            const file = document.getElementById('excelTrabajadores').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    // Validar columnas requeridas
                    if(!jsonData[0]?.['N√∫mero de Documento'] || !jsonData[0]?.Nombre || !jsonData[0]?.['N√∫mero de Celular']) {
                        throw new Error("Formato incorrecto. Columnas requeridas: N√∫mero de Documento, Nombre, N√∫mero de Celular");
                    }

                    const trabajadores = jsonData.reduce((acc, t) => {
                        acc[t.Nombre.toUpperCase()] = {
                            password: t['N√∫mero de Documento'],
                            role: 'worker',
                            documento: t['N√∫mero de Documento'],
                            celular: t['N√∫mero de Celular'],
                            nomina: []
                        };
                        return acc;
                    }, {});

                    localStorage.setItem('trabajadores', JSON.stringify(trabajadores));
                    actualizarListaTrabajadores();
                    mostrarTablaTrabajadores(trabajadores);
                    alert("Trabajadores importados exitosamente!");
                } catch (error) {
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Funci√≥n para actualizar lista de trabajadores
        function actualizarListaTrabajadores() {
            const trabajadores = JSON.parse(localStorage.getItem('trabajadores')) || {};
            const sedes = JSON.parse(localStorage.getItem('sedes')) || [];
            
            // Actualizar selects
            const selectTrabajador = document.getElementById('selectTrabajador');
            const selectSede = document.getElementById('selectSede');
            
            selectTrabajador.innerHTML = '<option value="">Seleccionar Trabajador</option>';
            selectSede.innerHTML = '<option value="">Seleccionar Sede</option>';
            
            Object.keys(trabajadores).forEach(t => {
                selectTrabajador.innerHTML += `<option value="${t}">${t}</option>`;
            });
            
            sedes.forEach(s => {
                selectSede.innerHTML += `<option value="${s.Nombre}">${s.Nombre}</option>`;
            });
        }

        // Funci√≥n para mostrar la tabla de trabajadores
function mostrarTablaTrabajadores(trabajadores) {
    const tbody = document.getElementById('tablaTrabajadores');
    tbody.innerHTML = '';

    Object.entries(trabajadores).forEach(([nombre, datos]) => {
        const row = `
            <tr>
                <td>${nombre}</td>
                <td>${datos.documento}</td>
                <td>${datos.celular}</td>
                <td>${datos.role}</td>
                <td>${datos.password}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

        // Funci√≥n para asignar sedes
        function asignarSede() {
            const trabajador = document.getElementById('selectTrabajador').value;
            const sede = document.getElementById('selectSede').value;

            if(!trabajador || !sede) {
                alert("Seleccione un trabajador y una sede");
                return;
            }

            const asignaciones = JSON.parse(localStorage.getItem('asignaciones')) || {};
            asignaciones[trabajador] = sede;
            localStorage.setItem('asignaciones', JSON.stringify(asignaciones));
            alert("Sede asignada exitosamente!");

            // Actualizar la interfaz de usuario
            actualizarListaTrabajadores();
        }

        // Funci√≥n para tracking en tiempo real de trabajadores
        function iniciarTrackingTrabajador() {
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    const ubicacion = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: new Date().toISOString()
                    };

                    const ubicaciones = JSON.parse(localStorage.getItem('ubicaciones')) || {};
                    ubicaciones[usuarioActual.username] = ubicacion;
                    localStorage.setItem('ubicaciones', JSON.stringify(ubicaciones));

                    // Actualizar marcador del trabajador en el mapa
                    if (userMarker) {
                        userMarker.setLatLng([ubicacion.lat, ubicacion.lng]);
                    } else {
                        userMarker = L.marker([ubicacion.lat, ubicacion.lng]).addTo(map);
                    }

                    // Actualizar c√≠rculo de precisi√≥n
                    if (accuracyCircle) {
                        accuracyCircle.setLatLng([ubicacion.lat, ubicacion.lng])
                            .setRadius(position.coords.accuracy * CONFIG.estilos.precision.escala);
                    } else {
                        accuracyCircle = L.circle([ubicacion.lat, ubicacion.lng], { 
                            radius: position.coords.accuracy * CONFIG.estilos.precision.escala,
                            color: CONFIG.estilos.precision.color, 
                            fillColor: CONFIG.estilos.precision.color, 
                            fillOpacity: CONFIG.estilos.precision.relleno, 
                        }).addTo(map);
                    }

                    // Actualizar l√≠nea entre usuario y destino
                    if (polyline) {
                        polyline.setLatLngs([[CONFIG.destino.lat, CONFIG.destino.lng], [ubicacion.lat, ubicacion.lng]]);
                    } else {
                        polyline = L.polyline([[CONFIG.destino.lat, CONFIG.destino.lng], [ubicacion.lat, ubicacion.lng]], CONFIG.estilos.lineaConexion).addTo(map);
                    }
                }, error => {
                    console.error(`Error de geolocalizaci√≥n (${error.code}): ${error.message}`);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 15000
                });
            }
        }

        function actualizarUI() {
            if(usuarioActual.role === 'admin') {
                document.querySelector('.tabs').style.display = 'flex';
                document.querySelector('.content-wrapper').style.display = 'block';
                document.querySelector('.nomina-panel').style.display = 'none';
                openTab('programacion', { currentTarget: document.querySelector('.tab-btn.active') }); // Pass a mock event
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            } else {
                document.querySelector('.tabs').style.display = 'none';
                document.querySelector('.nomina-panel').style.display = 'block';
                document.getElementById('mapa').style.display = 'none';
                document.getElementById('sedes').style.display = 'none';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            }
        }

        function mostrarNomina() {
            const trabajador = usuarioActual.datos;
            const tbody = document.getElementById('registro-nomina');
            let total = 0;
            document.getElementById('nombre-trabajador').textContent = trabajador.username;
            tbody.innerHTML = '';
            trabajador.nomina.forEach(dia => {
                const totalDia = dia.horas * dia.valorHora;
                total += totalDia;
                tbody.innerHTML += `
                    <tr>
                        <td>${dia.fecha}</td>
                        <td>${dia.horas}</td>
                        <td>$${dia.valorHora.toLocaleString()}</td>
                        <td>$${totalDia.toLocaleString()}</td>
                    </tr>
                `;
            });
            document.getElementById('total-pagar').textContent = total.toLocaleString();
        }

        const calcularDistancia = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI/180;
            const ŒîŒª = (lon2 - lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const manejarPosicion = (position) => {
            if (!map) {
                console.error("El mapa no est√° inicializado.");
                return;
            }

            const userCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            document.getElementById('coordinates').textContent = `üìå Tus coordenadas: ${userCoords.lat.toFixed(5)}, ${userCoords.lng.toFixed(5)}`;
            const distancia = calcularDistancia(userCoords.lat, userCoords.lng, CONFIG.destino.lat, CONFIG.destino.lng);
            document.getElementById('distance').textContent = `Distancia al destino: ${distancia.toFixed(2)} metros`;
            if (distancia <= CONFIG.destino.radio) {
                alert("¬°Est√°s dentro del √°rea permitida!");
            }
            if (userMarker) {
                userMarker.setLatLng([userCoords.lat, userCoords.lng]);
            } else {
                userMarker = L.marker([userCoords.lat, userCoords.lng]).addTo(map);
            }
            if (accuracyCircle) {
                accuracyCircle.setLatLng([userCoords.lat, userCoords.lng])
                    .setRadius(userCoords.accuracy * CONFIG.estilos.precision.escala);
            } else {
                accuracyCircle = L.circle([userCoords.lat, userCoords.lng], { 
                    radius: userCoords.accuracy * CONFIG.estilos.precision.escala,
                    color: CONFIG.estilos.precision.color, 
                    fillColor: CONFIG.estilos.precision.color, 
                    fillOpacity: CONFIG.estilos.precision.relleno, 
                }).addTo(map);
            }
            if (polyline) {
                polyline.setLatLngs([[CONFIG.destino.lat, CONFIG.destino.lng], [userCoords.lat, userCoords.lng]]);
            } else {
                polyline = L.polyline([[CONFIG.destino.lat, CONFIG.destino.lng], [userCoords.lat, userCoords.lng]], CONFIG.estilos.lineaConexion).addTo(map);
            }
        };

        function iniciarGeolocalizacion() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    manejarPosicion,
                    (error) => {
                        console.error(`Error de geolocalizaci√≥n (${error.code}): ${error.message}`);
                        document.getElementById('status').innerHTML = "‚ùå Error al obtener ubicaci√≥n";
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 15000
                    }
                );
            } else {
                document.getElementById('status').innerHTML = "‚ùå Tu navegador no soporta geolocalizaci√≥n";
            }
        }

        window.onload = function() {
            try {
                const session = sessionStorage.getItem('session');
                document.getElementById('logoutBtn').style.display = session ? 'block' : 'none';
                
                if(!session) {
                    document.getElementById('loginModal').style.display = 'flex';
                } else {
                    document.querySelector('.content-wrapper').style.display = 'block';
                    usuarioActual = JSON.parse(session);
                    actualizarUI();
                    
                    if(usuarioActual.role === 'admin') {
                        inicializarMapa();
                        iniciarGeolocalizacion();
                    } else {
                        mostrarNomina();
                    }
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('An error occurred during initialization. Check the console for details.');
            }
        };

        function procesarProgramacion() {
            const file = document.getElementById('excelProgramacion').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    // Validar columnas requeridas (incluyendo Sede)
                    if (!jsonData[0]?.Sede || !jsonData[0]?.Fecha || !jsonData[0]?.Turno || !jsonData[0]?.Nombre) {
                        throw new Error("Formato incorrecto. Columnas requeridas: Sede, Fecha, Turno, Nombre");
                    }

                    // Validar que la sede exista
                    const sedesCargadas = JSON.parse(localStorage.getItem('sedes')) || [];
                    const sedesInvalidas = jsonData.filter(t => 
                        !sedesCargadas.some(s => s.Nombre === t.Sede)
                    );
                    
                    if (sedesInvalidas.length > 0) {
                        throw new Error(`Sedes no encontradas: ${sedesInvalidas.map(t => t.Sede).join(', ')}`);
                    }

                    localStorage.setItem('programacion', JSON.stringify(jsonData));
                    mostrarProgramacionAdmin(jsonData);
                    alert("Programaci√≥n cargada exitosamente!");
                } catch (error) {
                    alert(error.message);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function mostrarProgramacionAdmin(data) {
            const contenedor = document.getElementById('programacionData');
            contenedor.innerHTML = `
                <h4>üìã Programaci√≥n Cargada</h4>
                <table class="programacion-table">
                    <thead>
                        <tr>
                            <th>Sede</th>
                            <th>Nombre</th>
                            <th>Fecha</th>
                            <th>Turno</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.Sede}</td>
                                <td>${row.Nombre}</td>
                                <td>${row.Fecha}</td>
                                <td>${row.Turno}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            contenedor.style.display = 'block';
        }

        function cargarProgramacionTrabajador() {
            const programacion = JSON.parse(localStorage.getItem('programacion')) || [];
            const turnosUsuario = programacion.filter(t => t.Nombre === usuarioActual.username);
            const tbody = document.querySelector('#turnosTrabajador tbody');
            
            tbody.innerHTML = turnosUsuario.map(turno => `
                <tr>
                    <td>${turno.Fecha}</td>
                    <td>${turno.Turno}</td>
                    <td>${turno.estado === 'confirmado' ? '‚úÖ Confirmado' : 
                          turno.estado === 'rechazado' ? '‚ùå Rechazado' : '‚è≥ Pendiente'}</td>
                    <td>
                        ${turno.estado !== 'confirmado' ? `
                        <button class="confirmar-btn" 
                            onclick="confirmarTurno('${turno.Fecha}')">
                            Confirmar
                        </button>
                        <button class="rechazar-btn" 
                            onclick="rechazarTurno('${turno.Fecha}')">
                            Rechazar
                        </button>` : 'Sin acciones'}
                    </td>
                </tr>
            `).join('');
        }

        function rechazarTurno(fecha) {
            if(confirm("¬øEst√°s seguro de rechazar este turno?")) {
                let programacion = JSON.parse(localStorage.getItem('programacion'));
                programacion = programacion.map(t => {
                    if(t.Nombre === usuarioActual.username && t.Fecha === fecha) {
                        const turnoRechazado = {
                            ...t,
                            estado: 'rechazado',
                            fechaRechazo: new Date().toISOString()
                        };
                        
                        // Agregar notificaci√≥n
                        const notificaciones = JSON.parse(localStorage.getItem('notificaciones') || '[]');
                        notificaciones.push({
                            trabajador: usuarioActual.username,
                            fecha: fecha,
                            turno: t.Turno,
                            timestamp: new Date().toISOString()
                        });
                        localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
                        
                        return turnoRechazado;
                    }
                    return t;
                });
                
                localStorage.setItem('programacion', JSON.stringify(programacion));
                cargarProgramacionTrabajador();
                if(usuarioActual.role === 'admin') cargarNotificaciones();
            }
        }

        function cargarNotificaciones() {
            const notificaciones = JSON.parse(localStorage.getItem('notificaciones') || '[]');
            const contenedor = document.getElementById('listaNotificaciones');
            
            contenedor.innerHTML = notificaciones.map((notif, index) => `
                <div class="notificacion-item">
                    <div>
                        <strong>${notif.trabajador}</strong> rechaz√≥ el turno 
                        del ${notif.fecha} (${notif.turno})
                        <br><small>${new Date(notif.timestamp).toLocaleString()}</small>
                    </div>
                    <button onclick="marcarComoResuelto(${index})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function marcarComoResuelto(index) {
            const notificaciones = JSON.parse(localStorage.getItem('notificaciones'));
            notificaciones.splice(index, 1);
            localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
            cargarNotificaciones();
        }

        function openTab(tabName, event) {
            if(usuarioActual.role !== 'admin') return;

            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            if(tabName === 'mapa' && !map) {
                inicializarMapa();
            }
        }

        function procesarSedes() {
            const file = document.getElementById('excelSedes').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if(!jsonData[0]?.Nombre || !jsonData[0]?.Latitud || !jsonData[0]?.Longitud) {
                        throw new Error("Formato incorrecto. Se requieren columnas: Nombre, Latitud, Longitud");
                    }

                    sedes = jsonData;
                    localStorage.setItem('sedes', JSON.stringify(sedes));
                    actualizarSedesEnMapa();
                    mostrarListaSedes();
                    alert("Sedes cargadas exitosamente!");
                } catch (error) {
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function actualizarSedesEnMapa() {
            if (!map) return;

            // Limpiar marcadores existentes (excepto el del usuario)
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    map.removeLayer(layer);
                }
            });

            // A√±adir sedes desde el archivo
            sedes.forEach(sede => {
                L.marker([sede.Latitud, sede.Longitud])
                    .addTo(map)
                    .bindPopup(`<b>${sede.Nombre}</b>`);
            });

            // Buscar y marcar el destino principal
            const destinoPrincipal = sedes.find(s => s.Nombre === "Bogot√° D.C.");
            if (destinoPrincipal) {
                L.marker([destinoPrincipal.Latitud, destinoPrincipal.Longitud], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        iconSize: [25, 41]
                    })
                }).addTo(map)
                .bindPopup('<b>Punto de Destino Principal</b>');
            }
        }

        function mostrarListaSedes() {
            const contenedor = document.getElementById('listaSedes');
            contenedor.innerHTML = sedes.map(sede => `
                <div class="sede-item">
                    <h4>${sede.Nombre}</h4>
                    <p>Lat: ${sede.Latitud}, Lng: ${sede.Longitud}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
