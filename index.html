<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>AMA PLUS LOGISTICS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" 
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" 
          crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        .tabs {
            margin: 20px 0;
            gap: 10px;
            display: none;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #map {
            height: 70vh;
            width: calc(100% - 40px);
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #loginModal div {
            background: white;
            width: 300px;
            padding: 20px;
            border-radius: 8px;
        }
        #loginModal input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        #loginModal button {
            width: 100%;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #loginModal button:hover {
            background: #1d4ed8;
        }
        .info-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .nomina-panel {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            #map {
                height: 60vh;
                margin: 10px 0;
            }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2563eb;
            color: white;
        }
        #logoutBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }
        #logoutBtn:hover {
            background: #b91c1c;
        }
        .upload-section {
            margin: 15px;
            padding: 15px;
            background: #e2e8f0;
            border-radius: 8px;
        }
        .programacion-table {
            margin-top: 20px;
        }
        .confirmar-btn {
            padding: 5px 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirmado {
            background: #34d399;
        }
        .programacion-panel {
            display: none;
        }
        .rechazar-btn {
            padding: 5px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .notificaciones-panel {
            margin: 15px;
            padding: 15px;
            background: #fecaca;
            border-radius: 8px;
        }
        .notificacion-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-wrapper {
            display: none;
        }
        #compartiendo-ubicacion {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        #compartiendo-ubicacion th, #compartiendo-ubicacion td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        #compartiendo-ubicacion th {
            background-color: #2563eb;
            color: white;
        }
        .form-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #f8fafc;
        }
        .form-section h4 {
            color: #2563eb;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
        }
        .asignacion-section {
            margin: 15px;
            text-align: center;
        }
        .confirmar-btn {
            background: #2563eb !important;
            margin: 10px 0;
            padding: 12px 25px;
            font-size: 16px;
        }
        .estado {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        .confirmado {
            background: #34d399;
            color: white;
        }
        .rechazado {
            background: #ef4444;
            color: white;
        }
        .pendiente {
            background: #fbbf24;
            color: black;
        }
    </style>
</head>
<body>
    <button id="logoutBtn" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
    <div id="loginModal">
        <div>
            <h2>üîê Inicio de Sesi√≥n</h2>
            <input type="email" id="email" placeholder="Correo electr√≥nico" required>
            <input type="password" id="password" placeholder="Contrase√±a" required>
            <button onclick="login(event)">Ingresar</button>
        </div>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('programacion', event)">üìÖ Programaci√≥n</button>
        <button class="tab-btn" onclick="openTab('mapa', event)">üó∫Ô∏è Mapa</button>
        <button class="tab-btn" onclick="openTab('sedes', event)">üè¢ Sedes</button>
        <button class="tab-btn" onclick="openTab('trabajadores', event)">üë∑ Trabajadores</button>
        <button class="tab-btn" onclick="openTab('usuarios', event)">üë§ Usuarios</button>
    </div>
    <div class="content-wrapper">
        <div class="info-panel">
            <div id="programacion" class="tab-content active programacion-panel">
                <div class="upload-section">
                    <h3>üì§ Subir Programaci√≥n</h3>
                    <input type="file" id="excelProgramacion" accept=".xlsx, .xls">
                    <button onclick="procesarProgramacion()">Cargar Programaci√≥n</button>
                    <div id="programacionData"></div>
                </div>
                <div class="notificaciones-panel">
                    <h3>üö® Notificaciones</h3>
                    <div id="listaNotificaciones"></div>
                </div>
            </div>
            <div id="mapa" class="tab-content">
                <div id="map"></div>
                <table id="compartiendo-ubicacion">
                    <thead>
                        <tr>
                            <th>Trabajador</th>
                            <th>Latitud</th>
                            <th>Longitud</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="sedes" class="tab-content">
                <div class="upload-section">
                    <h3>üì§ Subir Sedes</h3>
                    <input type="file" id="excelSedes" accept=".xlsx, .xls">
                    <button onclick="procesarSedes()">Cargar Sedes</button>
                </div>
                <form id="add-sede-form">
                    <label for="sede-name">Nombre de la Sede:</label>
                    <input type="text" id="sede-name" required />
                    <label for="sede-lat">Latitud:</label>
                    <input type="number" id="sede-lat" step="any" required />
                    <label for="sede-lng">Longitud:</label>
                    <input type="number" id="sede-lng" step="any" required />
                    <button type="submit">Agregar Sede</button>
                </form>
                <div id="sedes-list">
                    <h3>Sedes:</h3>
                    <ul id="lista-sedes"></ul>
                </div>
            </div>
            <div id="trabajadores" class="tab-content">
                <div class="upload-section">
                    <div id="crearTrabajador" class="upload-section">
                        <h3>üÜï Crear Trabajador</h3>
                        <div class="form-section">
                            <h4>üì∑ Foto y Documento</h4>
                            <input type="file" id="fotoTrabajador" accept="image/*" required>
                            <select id="tipoDocumento" required>
                                <option value="">Tipo de Documento</option>
                                <option value="C√©dula">C√©dula</option>
                                <option value="Pasaporte">Pasaporte</option>
                            </select>
                            <input type="text" id="numeroDocumento" placeholder="N√∫mero de Documento" required>
                        </div>
                        <div class="form-section">
                            <h4>üë§ Datos Personales</h4>
                            <input type="text" id="nombreApellidos" placeholder="Nombre completo" required>
                            <input type="date" id="fechaNacimiento" required>
                            <select id="rh" required>
                                <option value="">Grupo Sangu√≠neo</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                            <select id="genero" required>
                                <option value="">G√©nero</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-section">
                            <h4>üìû Contacto</h4>
                            <input type="email" id="correoElectronico" placeholder="Correo electr√≥nico" required>
                            <input type="text" id="ciudad" placeholder="Ciudad" required>
                            <input type="text" id="barrioResidencia" placeholder="Barrio de Residencia">
                            <input type="text" id="direccionResidencia" placeholder="Direcci√≥n Completa" required>
                            <input type="tel" id="telefonoContacto" placeholder="Tel√©fono de Contacto" required>
                            <input type="tel" id="telefonoEmergencia" placeholder="Tel√©fono de Emergencia" required>
                        </div>
                        <div class="form-section">
                            <h4>üí≥ Datos Bancarios</h4>
                            <input type="text" id="banco" placeholder="Banco" required>
                            <select id="tipoCuenta" required>
                                <option value="">Tipo de Cuenta</option>
                                <option value="Ahorros">Ahorros</option>
                                <option value="Corriente">Corriente</option>
                            </select>
                            <input type="text" id="numeroCuenta" placeholder="N√∫mero de Cuenta" required>
                        </div>
                        <button onclick="crearTrabajador()" class="confirmar-btn">Guardar Trabajador</button>
                    </div>
                    <div id="listaTrabajadores">
                        <h3>üë∑ Lista de Trabajadores</h3>
                        <ul id="trabajadoresList"></ul>
                    </div>
                    <h3>üì§ Importar Trabajadores</h3>
                    <input type="file" id="excelTrabajadores" accept=".xlsx, .xls">
                    <button onclick="procesarTrabajadores()">Cargar Trabajadores</button>
                </div>
                <div class="asignacion-section">
                    <h3>üîÑ Asignaci√≥n Autom√°tica de Sedes</h3>
                    <button onclick="asignarSede()" class="confirmar-btn">Actualizar Asignaciones Diarias</button>
                </div>
            </div>
            <div id="usuarios" class="tab-content">
                <h3>üë§ Lista de Usuarios</h3>
                <table id="usuariosTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Contrase√±a</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="nomina-panel">
            <div class="programacion-panel">
                <h3>üìÖ Turnos Asignados</h3>
                <table id="turnosTrabajador">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Turno</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h2>üìÖ Liquidaci√≥n de N√≥mina</h2>
            <div id="nomina-info">
                <p>Usuario: <span id="nombre-trabajador"></span></p>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Horas Trabajadas</th>
                            <th>Valor por Hora</th>
                            <th>Total D√≠a</th>
                        </tr>
                    </thead>
                    <tbody id="registro-nomina"></tbody>
                </table>
                <p style="margin-top: 15px; font-weight: bold;">
                    Total a pagar: $<span id="total-pagar">0</span>
                </p>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script>
        let map;
        let sedes = [];
        let usuarioActual = null;
        let userMarker = null;
        let accuracyCircle = null;
        let trabajadoresMarkers = {};
        let sedesLayer = L.layerGroup();

        const CONFIG = {
            destino: {
                lat: 4.688636,
                lng: -74.132025,
                radio: 170
            },
            opcionesMapa: {
                zoomInicial: 15,
                maxZoom: 19
            },
            estilos: {
                precision: {
                    color: '#3b82f6',
                    relleno: 0.2,
                    escala: 0.5
                }
            }
        };

        function cerrarSesion() {
            sessionStorage.removeItem('session');
            usuarioActual = null;
            document.querySelector('.content-wrapper').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            if (map) {
                map.remove();
                map = null;
                userMarker = null;
                accuracyCircle = null;
            }
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            firebase.database().ref('ubicaciones').off();
        }

        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                return showError('Todos los campos son requeridos');
            }

            if (!isValidEmail(email)) {
                return showError('Formato de email inv√°lido');
            }

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                const db = firebase.database();
                const userSnapshot = await db.ref(`usuarios/${user.uid}`).once('value');
                
                if (!userSnapshot.exists()) {
                    await firebase.auth().signOut();
                    return showError('Usuario no registrado en el sistema');
                }

                const userData = userSnapshot.val();

                if (userData.estado === 'inactivo') {
                    await firebase.auth().signOut();
                    return showError('Cuenta desactivada. Contacte al administrador');
                }

                usuarioActual = {
                    uid: user.uid,
                    email: user.email,
                    role: userData.role || 'worker',
                    nombre: userData.nombre || 'Sin nombre',
                    documento: userData.documento
                };

                handleSuccessfulLogin();

            } catch (error) {
                handleAuthError(error);
            }
        }

        function handleAuthError(error) {
            console.error('Error en login:', error);
            let message = 'Error en autenticaci√≥n';

            switch (error.code) {
                case 'auth/user-not-found':
                    message = 'Usuario no registrado';
                    break;
                case 'auth/wrong-password':
                    message = 'Contrase√±a incorrecta';
                    break;
                case 'auth/too-many-requests':
                    message = 'Demasiados intentos. Intente m√°s tarde';
                    break;
                case 'auth/user-disabled':
                    message = 'Cuenta desactivada';
                    break;
                case 'auth/invalid-email':
                    message = 'Email inv√°lido';
                    break;
                case 'auth/invalid-login-credentials':
                    message = 'Credenciales inv√°lidas. Verifique sus datos';
                    break;
            }

            showError(message);
            document.getElementById('password').value = '';
        }

        async function procesarExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const errors = [];
                        const validatedData = jsonData.map((row, index) => {
                            if (!row['N√∫mero de Documento']) errors.push(`Fila ${index + 2}: Falta documento`);
                            if (!row['Correo Electr√≥nico']) errors.push(`Fila ${index + 2}: Falta email`);
                            return row;
                        });

                        resolve({ data: validatedData, errors });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

/**
 * üìõ Muestra los errores encontrados al importar trabajadores desde Excel.
 * @param {string[]} errors - Lista de mensajes de error generados por fila
 */
function handleImportErrors(errors) {
    if (!errors || errors.length === 0) return;

    const mensaje = `‚ùå Se encontraron ${errors.length} errores en el archivo:\n\n` + 
                    errors.map(error => `‚Ä¢ ${error}`).join('\n');

    showError(mensaje);
}

/**
 * ‚úÖ Procesa los resultados de la importaci√≥n de trabajadores desde Excel.
 * @param {PromiseSettledResult[]} resultados - Resultados de registrarTrabajador() para cada fila
 */
function handleImportResults(resultados) {
    const exitosos = resultados.filter(r => r.status === 'fulfilled' && r.value.success);
    const fallidos = resultados.filter(r => r.status === 'rejected' || !r.value.success);

    if (fallidos.length > 0) {
        const errores = fallidos.map((f, i) => {
            const mensaje = f.reason?.message || f.value?.error || 'Error desconocido';
            return `Fila ${i + 2}: ${mensaje}`;
        });
        handleImportErrors(errores);
    }

    if (exitosos.length > 0) {
        alert(`‚úÖ ${exitosos.length} trabajador(es) importado(s) exitosamente.`);
    }

    if (exitosos.length === 0 && fallidos.length === 0) {
        showError("No se proces√≥ ning√∫n registro. Verifica el archivo.");
    }
}

async function procesarTrabajadores() {
    const file = document.getElementById('excelTrabajadores').files[0];
    if (!file) return showError('Seleccione un archivo Excel');

    try {
        const { data, errors } = await procesarExcel(file);
        if (errors.length > 0) return handleImportErrors(errors);

        const resultados = await Promise.allSettled(
            data.map(t => registrarTrabajador(t))
        );

        handleImportResults(resultados);
        cargarTrabajadores();

    } catch (error) {
        showError(`Error cr√≠tico: ${error.message}`);
    }
}


        async function registrarTrabajador(t) {
            try {
                const camposRequeridos = ['N√∫mero de Documento', 'Nombre', 'Correo Electr√≥nico'];
                const faltantes = camposRequeridos.filter(campo => !t[campo]);
                if (faltantes.length > 0) throw new Error(`Campos faltantes: ${faltantes.join(', ')}`);

                const userCredential = await firebase.auth()
                    .createUserWithEmailAndPassword(t['Correo Electr√≥nico'], t['N√∫mero de Documento']);

                const trabajadorData = {
                    numeroDocumento: t['N√∫mero de Documento'],
                    nombreApellidos: t['Nombre'],
                    correoElectronico: t['Correo Electr√≥nico'],
                    role: 'worker',
                    estado: 'activo',
                    password: t['N√∫mero de Documento'] // Temporalmente almacenado para este ejemplo
                };

                await Promise.all([
                    firebase.database().ref(`usuarios/${userCredential.user.uid}`).set(trabajadorData),
                    firebase.database().ref(`trabajadores/${t['N√∫mero de Documento']}`).set(trabajadorData)
                ]);

                return { success: true, documento: t['N√∫mero de Documento'] };

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    await handleExistingUser(t, t['N√∫mero de Documento'], t['Correo Electr√≥nico']);

                    return { success: false, error: 'Email ya registrado' };
                }
                throw error;
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidDocumentNumber(documento) {
            return /^[0-9]{8,15}$/.test(documento);
        }

        async function handleExistingUser(t, documento, email) {
            const snapshot = await firebase.database().ref('trabajadores').orderByChild('numeroDocumento').equalTo(documento).once('value');
            if (!snapshot.exists()) {
                await firebase.auth().signInWithEmailAndPassword(email, documento);
                await firebase.auth().currentUser.delete();
            }
        }

        function showError(message) {
            alert(`Error: ${message}`);
        }

function handleSuccessfulLogin() {
    document.getElementById('loginModal').style.display = 'none';
    document.querySelector('.content-wrapper').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'block';
    sessionStorage.setItem('session', JSON.stringify(usuarioActual));
    actualizarUI();

    // Llama a cargarUsuarios despu√©s de iniciar sesi√≥n (solo para administradores)
    if (usuarioActual.role === 'admin') {
        cargarUsuarios();
        cargarUbicacionesTrabajadores();
    }

    // Solicitar la ubicaci√≥n del trabajador despu√©s de iniciar sesi√≥n (solo para trabajadores)
    if (usuarioActual.role === 'trabajador') {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const { latitude, longitude } = position.coords;
                    console.log('Ubicaci√≥n obtenida:', latitude, longitude);
                    guardarUbicacionEnFirebase(usuarioActual.uid, latitude, longitude);
                },
                function(error) {
                    console.error('Error al obtener la ubicaci√≥n:', error);
                    let mensajeError = 'No se pudo obtener la ubicaci√≥n.';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            mensajeError = 'Permiso de ubicaci√≥n denegado.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensajeError = 'Informaci√≥n de ubicaci√≥n no disponible.';
                            break;
                        case error.TIMEOUT:
                            mensajeError = 'Tiempo de espera agotado al intentar obtener la ubicaci√≥n.';
                            break;
                    }
                    alert(mensajeError + ' Por favor, verifica la configuraci√≥n de tu dispositivo.');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 0
                }
            );
        } else {
            console.error('La geolocalizaci√≥n no es soportada por este navegador.');
            alert('La geolocalizaci√≥n no es compatible con tu navegador.');
        }
    }

    // Inicializar el mapa despu√©s de un breve retraso para asegurar que el DOM est√© listo
    setTimeout(inicializarMapa, 150); // Ajusta el tiempo si es necesario
}
async function inicializarMapa() {
    if (!map) {
        // Esperar un breve momento para asegurar que el elemento del mapa est√© en el DOM
        await new Promise(resolve => setTimeout(resolve, 50));

        const mapElement = document.getElementById('map');
        if (mapElement) {
            map = L.map('map', {
                maxZoom: CONFIG.opcionesMapa.maxZoom,
                preferCanvas: true
            }).setView([CONFIG.destino.lat, CONFIG.destino.lng], CONFIG.opcionesMapa.zoomInicial);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxNativeZoom: 19,
                maxZoom: 22
            }).addTo(map);

            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 200);

            try {
                await loadSedes();
                actualizarSedesEnMapa();
            } catch (error) {
                console.error('Error al cargar o actualizar sedes:', error);
                alert('Error al cargar la informaci√≥n de las sedes.');
            }

        } else {
            console.error('El elemento con ID "map" no se encontr√≥ en el DOM.');
            alert('Error al inicializar el mapa: el contenedor no se encontr√≥.');
        }
    }
}

async function guardarUbicacionEnFirebase(userId, latitude, longitude) {
    try {
        const db = firebase.database();
        const ubicacionRef = db.ref(`ubicaciones/${userId}`);
        const userData = JSON.parse(sessionStorage.getItem('session'));
        await ubicacionRef.set({
            lat: latitude,
            lng: longitude,
            nombre: userData && userData.displayName ? userData.displayName : 'Trabajador',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        console.log('Ubicaci√≥n guardada en Firebase');
    } catch (error) {
        console.error('Error al guardar la ubicaci√≥n en Firebase:', error);
        alert('Error al guardar la ubicaci√≥n.');
    }
}

async function cargarUbicacionesTrabajadores() {
    try {
        const db = firebase.database();
        const ubicacionesRef = db.ref('ubicaciones');

        ubicacionesRef.on('value', (snapshot) => {
            const ubicaciones = snapshot.val() || {};
            actualizarTablaUbicaciones(ubicaciones);
            actualizarMapaTrabajadores(ubicaciones);
        });

        window.addEventListener('beforeunload', () => {
            ubicacionesRef.off();
        });
    } catch (error) {
        console.error('Error al cargar ubicaciones:', error);
        alert('Error al cargar las ubicaciones de los trabajadores.');
    }
}

function actualizarMapaTrabajadores(ubicaciones) {
    if (!map) return;
    const procesados = new Set();
    Object.keys(ubicaciones).forEach(trabajadorKey => {
        const ubicacion = ubicaciones[trabajadorKey];
        if (ubicacion && typeof ubicacion.lat === 'number' && typeof ubicacion.lng === 'number') {
            const marker = trabajadoresMarkers[trabajadorKey];
            procesados.add(trabajadorKey);
            const popupContent = `Trabajador: ${ubicacion.nombre || trabajadorKey}<br>Lat: ${ubicacion.lat.toFixed(5)}<br>Lng: ${ubicacion.lng.toFixed(5)}`;
            if (marker) {
                marker.setLatLng([ubicacion.lat, ubicacion.lng]).setPopupContent(popupContent);
            } else {
                trabajadoresMarkers[trabajadorKey] = L.marker([ubicacion.lat, ubicacion.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(map).bindPopup(popupContent);
            }
        }
    });
    Object.keys(trabajadoresMarkers).forEach(key => {
        if (!procesados.has(key)) {
            map.removeLayer(trabajadoresMarkers[key]);
            delete trabajadoresMarkers[key];
        }
    });
}

function actualizarTablaUbicaciones(ubicaciones) {
    const tbody = document.querySelector('#compartiendo-ubicacion tbody');
    if (!tbody) {
        console.error('No se encontr√≥ la tabla de ubicaciones.');
        return;
    }
    tbody.innerHTML = '';
    if (!ubicaciones || Object.keys(ubicaciones).length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No hay ubicaciones disponibles</td></tr>';
        return;
    }
    Object.keys(ubicaciones).forEach(trabajadorKey => {
        const ubicacion = ubicaciones[trabajadorKey];
        const row = document.createElement('tr');
        if (ubicacion && ubicacion.lat && ubicacion.lng) {
            const fecha = ubicacion.timestamp ? new Date(ubicacion.timestamp).toLocaleString() : 'Sin fecha';
            row.innerHTML = `
                <td>${trabajadorKey}</td>
                <td>${ubicacion.lat.toFixed(5)}</td>
                <td>${ubicacion.lng.toFixed(5)}</td>
                <td>${fecha}</td>
            `;
        } else {
            row.innerHTML = `<td>${trabajadorKey}</td><td colspan="3">Ubicaci√≥n no disponible</td>`;
        }
        tbody.appendChild(row);
    });
}
        async function loadSedes() {
    try {
        const db = firebase.database();
        const snapshot = await db.ref("sedes").once("value");
        const sedesData = snapshot.val() || {};
        sedes = Object.values(sedesData);

        const sedesList = document.getElementById('lista-sedes');
        sedesList.innerHTML = '';
        sedes.forEach(sede => {
            const li = document.createElement('li');
            li.textContent = `${sede.nombre} - Lat: ${sede.latitud}, Lng: ${sede.longitud}`;
            sedesList.appendChild(li);
        });

    } catch (error) {
        console.error('Error al cargar sedes:', error);
    }
}

// Asegura que inicializarMapa se llame cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Si quieres que el mapa cargue inmediatamente al cargar la p√°gina, llama a inicializarMapa aqu√≠.
    // Si prefieres que cargue solo despu√©s del login, aseg√∫rate de que se llame en handleSuccessfulLogin.
    // La llamada en handleSuccessfulLogin se ha modificado para que se ejecute con un peque√±o retraso.
});

        document.getElementById('add-sede-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const sedeName = document.getElementById('sede-name').value;
            const sedeLat = parseFloat(document.getElementById('sede-lat').value);
            const sedeLng = parseFloat(document.getElementById('sede-lng').value);

            if (!sedeName || isNaN(sedeLat) || isNaN(sedeLng)) {
                alert('Por favor completa todos los campos.');
                return;
            }

            const newSede = { nombre: sedeName, latitud: sedeLat, longitud: sedeLng };
            sedes.push(newSede);
            await guardarEnFirebase(`sedes/${sedeName}`, newSede);
            loadSedes();
            alert('Sede agregada exitosamente.');
        });

        async function cargarTrabajadores() {
            try {
                const db = firebase.database();
                const snapshot = await db.ref("trabajadores").once("value");
                const trabajadores = snapshot.val() || {};
                const lista = document.getElementById('trabajadoresList');
                lista.innerHTML = '';
                Object.values(trabajadores).forEach(trabajador => {
                    if (trabajador.nombreApellidos && trabajador.numeroDocumento) {
                        const li = document.createElement('li');
                        li.textContent = `${trabajador.nombreApellidos} - Documento: ${trabajador.numeroDocumento}`;
                        lista.appendChild(li);
                    }
                });
            } catch (error) {
                console.error('Error al cargar trabajadores:', error);
            }
        }

        async function actualizarListaTrabajadores() {
            try {
                const db = firebase.database();
                const snapshot = await db.ref("trabajadores").once("value");
                const trabajadoresData = snapshot.val() || {};
                const trabajadores = Object.values(trabajadoresData);

                const lista = document.getElementById('trabajadoresList');
                lista.innerHTML = '';

                if (trabajadores.length === 0) {
                    lista.innerHTML = '<li>No hay trabajadores registrados</li>';
                    return;
                }

                trabajadores.forEach(trabajador => {
                    const li = document.createElement('li');
                    li.className = 'trabajador-item';
                    li.innerHTML = `
                        <div class="trabajador-info">
                            <span class="nombre">${trabajador.nombreApellidos || 'Sin nombre'}</span>
                            <span class="documento">Documento: ${trabajador.numeroDocumento}</span>
                        </div>
                    `;
                    lista.appendChild(li);
                });
            } catch (error) {
                console.error('Error al actualizar lista de trabajadores:', error);
                const lista = document.getElementById('trabajadoresList');
                lista.innerHTML = '<li>Error al cargar trabajadores</li>';
            }
        }

        async function asignarSede() {
            try {
                const db = firebase.database();
                const hoy = new Date().toISOString().split('T')[0];

                const snapshotProgramacion = await db.ref(`programacion/${hoy}`).once("value");
                const programacionHoy = snapshotProgramacion.val();

                if (!programacionHoy) {
                    alert("No hay programaci√≥n cargada para hoy.");
                    return;
                }

                const snapshotTrabajadores = await db.ref("trabajadores").once("value");
                const trabajadores = snapshotTrabajadores.val() || {};
                const snapshotSedes = await db.ref("sedes").once("value");
                const sedes = snapshotSedes.val() || {};

                if (Object.keys(trabajadores).length === 0 || Object.keys(sedes).length === 0) {
                    alert("No hay trabajadores o sedes registrados.");
                    return;
                }

                const asignacionesRef = db.ref("asignaciones");
                await asignacionesRef.child(hoy).set(programacionHoy);

                alert("‚úÖ Sedes asignadas autom√°ticamente seg√∫n la programaci√≥n de hoy.");
            } catch (error) {
                console.error("Error al asignar sedes:", error);
                alert("‚ùå Error al asignar sedes. Verifica la consola.");
            }
        }

        async function iniciarTrackingTrabajador() {
            if (!navigator.geolocation || usuarioActual.role !== 'worker') return;

            try {
                const db = firebase.database();
                const ubicacionRef = db.ref(`ubicaciones/${usuarioActual.uid}`);
                
                const watchId = navigator.geolocation.watchPosition(
                    async (position) => {
                        const ubicacion = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString(),
                            nombre: usuarioActual.nombre || 'Trabajador'
                        };

                        try {
                            await ubicacionRef.set(ubicacion);
                            
                            if (map) {
                                const latLng = [ubicacion.lat, ubicacion.lng];
                                
                                if (userMarker) {
                                    userMarker.setLatLng(latLng)
                                             .setPopupContent(`${usuarioActual.nombre}<br>√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`);
                                } else {
                                    userMarker = L.marker(latLng, {
                                        icon: L.icon({
                                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                                            iconSize: [25, 41]
                                        })
                                    }).addTo(map).bindPopup(usuarioActual.nombre);
                                }

                                if (accuracyCircle) {
                                    accuracyCircle.setLatLng(latLng)
                                                 .setRadius(ubicacion.accuracy);
                                } else {
                                    accuracyCircle = L.circle(latLng, {
                                        radius: ubicacion.accuracy,
                                        color: '#3b82f6',
                                        fillOpacity: 0.2
                                    }).addTo(map);
                                }
                            }
                            
                            actualizarTablaUbicaciones({ [usuarioActual.uid]: ubicacion });
                        } catch (error) {
                            console.error('Error al actualizar ubicaci√≥n:', error);
                        }
                    },
                    (error) => {
                        console.error('Error de geolocalizaci√≥n:', error);
                        alert(`Error de GPS: ${error.message}`);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 10000
                    }
                );

                window.addEventListener('beforeunload', () => {
                    navigator.geolocation.clearWatch(watchId);
                    ubicacionRef.remove();
                });
            } catch (error) {
                console.error('Error en tracking:', error);
                alert('No se pudo iniciar el seguimiento. Verifica los permisos de ubicaci√≥n.');
            }
        }

function actualizarUI() {
    if (usuarioActual.role === 'admin') {
        document.querySelector('.tabs').style.display = 'flex';
        document.querySelector('.info-panel').style.display = 'block';
        document.querySelector('.nomina-panel').style.display = 'none';
        // Ocultar todos los tabs primero
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
            tab.classList.remove('active');
        });
        // Mostrar solo programaci√≥n
        document.getElementById('programacion').style.display = 'block';
        document.getElementById('programacion').classList.add('active');
    } else {
        document.querySelector('.tabs').style.display = 'none';
        document.querySelector('.info-panel').style.display = 'none';
        document.querySelector('.nomina-panel').style.display = 'block';
    }
}

        async function mostrarNomina() {
            try {
                const db = firebase.database();
                const snapshot = await db.ref(`trabajadores/${usuarioActual.documento}`).once('value');
                const trabajadorData = snapshot.val() || {};
                const tbody = document.getElementById('registro-nomina');
                let total = 0;

                document.getElementById('nombre-trabajador').textContent = trabajadorData.nombreApellidos || usuarioActual.email;
                tbody.innerHTML = '';

                const nomina = trabajadorData.nomina || [];
                nomina.forEach(dia => {
                    const totalDia = dia.horas * dia.valorHora;
                    total += totalDia;
                    tbody.innerHTML += `
                        <tr>
                            <td>${dia.fecha}</td>
                            <td>${dia.horas}</td>
                            <td>$${dia.valorHora.toLocaleString()}</td>
                            <td>$${totalDia.toLocaleString()}</td>
                        </tr>
                    `;
                });
                document.getElementById('total-pagar').textContent = total.toLocaleString();
            } catch (error) {
                console.error('Error al mostrar n√≥mina:', error);
                alert('Error al cargar la n√≥mina.');
            }
        }

        window.onload = async function() {
            try {
                const session = sessionStorage.getItem('session');
                document.getElementById('logoutBtn').style.display = session ? 'block' : 'none';
                
                if (!session) {
                    document.getElementById('loginModal').style.display = 'flex';
                    return;
                }

                usuarioActual = JSON.parse(session);
                document.querySelector('.content-wrapper').style.display = 'block';
                actualizarUI();

                await Promise.all([
                    cargarTrabajadores(),
                    loadSedes()
                ]);

                if (usuarioActual.role === 'admin') {
                    await asignarSede();
                    const ahora = new Date();
                    const horaEjecucion = new Date(
                        ahora.getFullYear(),
                        ahora.getMonth(),
                        ahora.getDate() + 1,
                        0, 0, 0
                    );
                    const tiempoHastaEjecucion = horaEjecucion - ahora;
                    
                    setTimeout(() => {
                        setInterval(asignarSede, 86400000);
                    }, tiempoHastaEjecucion);

                    cargarUbicacionesTrabajadores();
                    cargarNotificaciones();
                } else {
                    mostrarNomina();
                    iniciarTrackingTrabajador();
                    cargarProgramacionTrabajador();
                }
            } catch (error) {
                console.error('Error en carga inicial:', error);
                alert('Error al iniciar la aplicaci√≥n');
                cerrarSesion();
            }
        };

        async function procesarProgramacion() {
            const file = document.getElementById('excelProgramacion').files[0];
            if (!file) {
                alert('Por favor selecciona un archivo');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (!jsonData[0]?.['Fecha'] || !jsonData[0]?.['Nombre'] || !jsonData[0]?.['Sede'] || !jsonData[0]?.['Turno']) {
                        throw new Error("Formato incorrecto. Columnas requeridas: Fecha, Nombre, Sede, Turno");
                    }

                    const db = firebase.database();
                    const programacionRef = db.ref("programacion");
                    
                    await Promise.all(
                        jsonData.map(async (registro) => {
                            const fecha = registro.Fecha;
                            const email = registro.Nombre;
                            await programacionRef.child(fecha).child(email).set({
                                sede: registro.Sede,
                                turno: registro.Turno,
                                estado: 'pendiente'
                            });
                        })
                    );

                    mostrarProgramacionAdmin(jsonData);
                    alert("Programaci√≥n cargada exitosamente!");
                } catch (error) {
                    console.error('Error al procesar programaci√≥n:', error);
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function mostrarProgramacionAdmin(data) {
            const contenedor = document.getElementById('programacionData');
            contenedor.innerHTML = `
                <h4>üìã Programaci√≥n Cargada</h4>
                <table class="programacion-table">
                    <thead>
                        <tr>
                            <th>Sede</th>
                            <th>Nombre</th>
                            <th>Fecha</th>
                            <th>Turno</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.Sede}</td>
                                <td>${row.Nombre}</td>
                                <td>${row.Fecha}</td>
                                <td>${row.Turno}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            contenedor.style.display = 'block';
        }

        async function cargarProgramacionTrabajador() {
            try {
                const db = firebase.database();
                const snapshot = await db.ref("programacion").once("value");
                const programacion = snapshot.val() || {};
                
                const emailTrabajador = usuarioActual.email;
                const turnos = [];
                
                Object.keys(programacion).forEach(fecha => {
                    const turnosFecha = programacion[fecha];
                    if (turnosFecha[emailTrabajador]) {
                        turnos.push({
                            fecha: fecha,
                            sede: turnosFecha[emailTrabajador].sede || 'Sin sede',
                            turno: turnosFecha[emailTrabajador].turno || 'Sin turno',
                            estado: turnosFecha[emailTrabajador].estado || 'pendiente'
                        });
                    }
                });

                const tbody = document.querySelector('#turnosTrabajador tbody');
                tbody.innerHTML = '';

                if (turnos.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4">No hay turnos asignados</td></tr>`;
                    return;
                }

                turnos.forEach(turno => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${turno.fecha}</td>
                        <td>${turno.turno}</td>
                        <td><span class="estado ${turno.estado}">${turno.estado.toUpperCase()}</span></td>
                        <td>
                            ${turno.estado === 'pendiente' ? `
                            <button class="confirmar-btn" 
                                    onclick="confirmarTurno('${turno.fecha}')">
                                ‚úÖ Confirmar
                            </button>
                            <button class="rechazar-btn" 
                                    onclick="rechazarTurno('${turno.fecha}')">
                                ‚ùå Rechazar
                            </button>
                            ` : 'Sin acciones disponibles'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.querySelectorAll('.estado').forEach(estado => {
                    estado.classList.add(
                        estado.textContent.toLowerCase() === 'confirmado' ? 'confirmado' :
                        estado.textContent.toLowerCase() === 'rechazado' ? 'rechazado' : 'pendiente'
                    );
                });
            } catch (error) {
                console.error('Error al cargar programaci√≥n:', error);
                const tbody = document.querySelector('#turnosTrabajador tbody');
                tbody.innerHTML = `<tr><td colspan="4">Error al cargar la programaci√≥n</td></tr>`;
            }
        }

        async function confirmarTurno(fecha) {
            try {
                const db = firebase.database();
                const programacionRef = db.ref(`programacion/${fecha}/${usuarioActual.email}`);
                await programacionRef.update({ estado: 'confirmado' });
                cargarProgramacionTrabajador();
                alert("Turno confirmado exitosamente.");
            } catch (error) {
                console.error('Error al confirmar turno:', error);
                alert('Error al confirmar el turno.');
            }
        }

        async function rechazarTurno(fecha) {
            if (confirm("¬øEst√°s seguro de rechazar este turno?")) {
                try {
                    const db = firebase.database();
                    const programacionRef = db.ref(`programacion/${fecha}/${usuarioActual.email}`);
                    const snapshot = await programacionRef.once("value");
                    const turnoData = snapshot.val();

                    await programacionRef.update({ 
                        estado: 'rechazado',
                        fechaRechazo: new Date().toISOString()
                    });

                    const notificacionesRef = db.ref("notificaciones");
                    const notificacion = {
                        trabajador: usuarioActual.email,
                        fecha: fecha,
                        turno: turnoData.turno,
                        timestamp: new Date().toISOString()
                    };
                    await notificacionesRef.push(notificacion);

                    cargarProgramacionTrabajador();
                    if (usuarioActual.role === 'admin') cargarNotificaciones();
                    alert("Turno rechazado exitosamente.");
                } catch (error) {
                    console.error('Error al rechazar turno:', error);
                    alert('Error al rechazar el turno.');
                }
            }
        }

        async function cargarNotificaciones() {
            try {
                const db = firebase.database();
                const snapshot = await db.ref("notificaciones").once("value");
                const notificaciones = snapshot.val() || {};

                const listaNotificaciones = document.getElementById('listaNotificaciones');
                listaNotificaciones.innerHTML = Object.values(notificaciones).map(notif => `
                    <div class="notificacion-item">
                        <span>Turno rechazado por ${notif.trabajador} para ${notif.fecha}</span>
                        <small>${new Date(notif.timestamp).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error("Error al cargar notificaciones:", error);
                alert("No se pudieron cargar las notificaciones.");
            }
        }

function openTab(tabName, event) {
    // Ocultar todos los tab-content
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none'; // Oculta todos los contenidos de las pesta√±as
        tab.classList.remove('active'); // Elimina la clase activa
    });
    
    // Mostrar solo el tab seleccionado
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.style.display = 'block'; // Muestra el contenido de la pesta√±a seleccionada
        selectedTab.classList.add('active'); // Agrega la clase activa
        
        // Llama a la funci√≥n para inicializar el mapa si la pesta√±a es 'mapa'
        if (tabName === 'mapa') {
            inicializarMapa(); // Aseg√∫rate de que esta funci√≥n est√© definida
        }
    }
    
    // Manejar clases activas en los botones
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); // Elimina la clase activa de todos los botones
    event.currentTarget.classList.add('active'); // Agrega la clase activa al bot√≥n que fue clicado
}
        async function procesarSedes() {
            const file = document.getElementById('excelSedes').files[0];
            if (!file) return alert('Por favor selecciona un archivo');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (!jsonData[0]?.['Nombre'] || !jsonData[0]?.['Latitud'] || !jsonData[0]?.['Longitud']) {
                        throw new Error("Formato incorrecto. Columnas requeridas: Nombre, Latitud, Longitud");
                    }

                    const db = firebase.database();
                    const promesas = jsonData.map(async (row) => {
                        const sede = {
                            nombre: row.Nombre,
                            latitud: parseFloat(row.Latitud),
                            longitud: parseFloat(row.Longitud)
                        };
                        await db.ref(`sedes/${row.Nombre}`).set(sede);
                    });

                    await Promise.all(promesas);
                    loadSedes();
                    alert("Sedes importadas exitosamente!");
                } catch (error) {
                    console.error('Error al procesar sedes:', error);
                    alert(error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

function actualizarSedesEnMapa() {
    if (!map) return;
    try {
        // Limpiar marcadores anteriores
        sedesLayer.clearLayers();

        const sedeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });

        // A√±adir nuevos marcadores
        sedes.forEach(sede => {
            L.marker([sede.latitud, sede.longitud], { icon: sedeIcon })
                .addTo(sedesLayer)
                .bindPopup(`<b>${sede.nombre}</b>`);
        });

        // A√±adir el grupo al mapa
        sedesLayer.addTo(map);
    } catch (error) {
        console.error('Error al actualizar sedes en mapa:', error);
    }
}

        async function guardarEnFirebase(ruta, datos) {
            try {
                const db = firebase.database();
                const referencia = db.ref(ruta);
                await referencia.set(datos);
                console.log("Datos guardados exitosamente en:", ruta);
                return { exito: true, mensaje: "Datos guardados correctamente" };
            } catch (error) {
                console.error("Error al guardar en Firebase:", error);
                return { 
                    exito: false, 
                    mensaje: `Error al guardar: ${error.message || error}` 
                };
            }
        }

        async function convertirImagenABase64(file) {
            if (!file) return null;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

async function crearTrabajador(event) {
    event.preventDefault();
    const form = document.getElementById('crearTrabajador');
    const btn = form.querySelector('button.confirmar-btn');

    // Mostrar indicador de carga
    btn.disabled = true;
    btn.textContent = 'Guardando...';

    try {
        // Requerir campos esenciales
        const requiredIds = [
            'fotoTrabajador', 'tipoDocumento', 'numeroDocumento', 'nombreApellidos',
            'fechaNacimiento', 'rh', 'genero', 'correoElectronico', 'ciudad',
            'direccionResidencia', 'telefonoContacto', 'telefonoEmergencia',
            'banco', 'tipoCuenta', 'numeroCuenta'
        ];
        const missing = requiredIds.filter(id => {
            const el = document.getElementById(id);
            return !(el && (el.type === 'file' ? el.files.length : el.value));
        });
        if (missing.length) throw new Error(`Faltan campos: ${missing.join(', ')}`);

        // Validaciones espec√≠ficas
        const email = document.getElementById('correoElectronico').value.trim();
        if (!isValidEmail(email)) throw new Error('Correo inv√°lido');

        const documento = document.getElementById('numeroDocumento').value.trim();
        if (!isValidDocumentNumber(documento)) throw new Error('Documento inv√°lido');

        const telefono = document.getElementById('telefonoContacto').value.trim();
        if (!/^\+?\d{10,15}$/.test(telefono)) throw new Error('Tel√©fono inv√°lido');

        // Convertir foto a Base64
        const fotoFile = document.getElementById('fotoTrabajador').files[0];
        const fotoBase64 = await convertirImagenABase64(fotoFile);

        // Preparar datos
        const trabajadorData = {
            foto: fotoBase64,
            tipoDocumento: document.getElementById('tipoDocumento').value,
            numeroDocumento: documento,
            nombreApellidos: document.getElementById('nombreApellidos').value.trim(),
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            rh: document.getElementById('rh').value,
            genero: document.getElementById('genero').value,
            correoElectronico: email,
            ciudad: document.getElementById('ciudad').value.trim(),
            barrioResidencia: document.getElementById('barrioResidencia').value.trim(),
            direccionResidencia: document.getElementById('direccionResidencia').value.trim(),
            telefonoContacto: telefono,
            telefonoEmergencia: document.getElementById('telefonoEmergencia').value.trim(),
            banco: document.getElementById('banco').value.trim(),
            tipoCuenta: document.getElementById('tipoCuenta').value,
            numeroCuenta: document.getElementById('numeroCuenta').value.trim(),
            role: 'worker',
            fechaRegistro: new Date().toISOString(),
            activo: true,
            password: documento, // temporal
            nomina: []
        };

        // Crear usuario en Firebase Auth
        const cred = await firebase.auth()
            .createUserWithEmailAndPassword(email, documento);
        const uid = cred.user.uid;

        // Guardar en real-time database
        const db = firebase.database();
        await Promise.all([
            db.ref(`usuarios/${uid}`).set({
                nombre: trabajadorData.nombreApellidos,
                email,
                role: 'worker',
                documento,
                // No guardar contrase√±a en texto plano en producci√≥n
                password: trabajadorData.password
            }),
            db.ref(`trabajadores/${documento}`).set(trabajadorData)
        ]);

        // Refrescar vistas
        form.reset();
        actualizarListaTrabajadores();
        cargarUsuarios();

        alert(`Trabajador registrado:\nEmail: ${email}\nContrase√±a: ${documento}`);

    } catch (error) {
        console.error('Error al crear trabajador:', error);
        alert(`Error: ${error.message}`);
    } finally {
        // Restaurar estado del bot√≥n
        btn.disabled = false;
        btn.textContent = 'Guardar Trabajador';
    }
}


async function cargarUsuarios() {
    try {
        const db = firebase.database();
        const snapshot = await db.ref("usuarios").once("value");
        const usuarios = snapshot.val() || {};
        
        const tbody = document.querySelector('#usuariosTable tbody');
        if (!tbody) {
            console.warn('Tabla de usuarios no encontrada en el DOM.');
            return;
        }
        
        tbody.innerHTML = '';
        
        Object.keys(usuarios).forEach(uid => {
            const usuario = usuarios[uid];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${usuario.nombre || 'Sin nombre'}</td>
                <td>${usuario.email}</td>
                <td>${usuario.password || 'No disponible'}</td>
                <td><button onclick="resetPassword('${usuario.email}')">Restablecer Contrase√±a</button></td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error al cargar usuarios:', error);
        alert('Error al cargar la lista de usuarios.');
    }
}


        async function resetPassword(email) {
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                alert(`Correo de restablecimiento enviado a ${email}`);
            } catch (error) {
                console.error('Error al enviar correo de restablecimiento:', error);
                alert('Error al enviar el correo de restablecimiento.');
            }
        }
    </script>
    <script type="module" src="./main.js"></script>
</body>
</html>
